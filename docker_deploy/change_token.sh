#!/bin/bash

# üîë –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞

echo "ü§ñ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ Telegram –±–æ—Ç–∞"
echo "=================================="
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω (—á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç)
CURRENT_TOKEN=$(grep "BOT_TOKEN=" .env | cut -d'=' -f2)
if [ -n "$CURRENT_TOKEN" ]; then
    HIDDEN_TOKEN="${CURRENT_TOKEN:0:10}...${CURRENT_TOKEN: -10}"
    echo "–¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω: $HIDDEN_TOKEN"
else
    echo "–¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω: –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç–µ —É @BotFather):"
read NEW_TOKEN

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –ø—É—Å—Ç–æ–π
if [ -z "$NEW_TOKEN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞ (–±–∞–∑–æ–≤–∞—è)
if [[ ! "$NEW_TOKEN" =~ ^[0-9]+:[A-Za-z0-9_-]+$ ]]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ"
    echo "–¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–∞: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
    echo ""
    echo "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ? (y/n)"
    read CONFIRM
    if [ "$CONFIRM" != "y" ]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
        exit 0
    fi
fi

# –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"

# –ó–∞–º–µ–Ω—è–µ–º —Ç–æ–∫–µ–Ω
if grep -q "BOT_TOKEN=" .env; then
    # –¢–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å - –∑–∞–º–µ–Ω—è–µ–º
    sed -i.tmp "s|BOT_TOKEN=.*|BOT_TOKEN=$NEW_TOKEN|" .env
    rm -f .env.tmp
    echo "‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω"
else
    # –¢–æ–∫–µ–Ω–∞ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º
    echo "BOT_TOKEN=$NEW_TOKEN" >> .env
    echo "‚úÖ –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω"
fi

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ!"
echo ""
echo "–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:"
echo "  docker-compose restart"
echo ""
echo "–ò–ª–∏ –µ—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ:"
echo "  python run_modern_bot.py"
