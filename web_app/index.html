<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover: #0062cc;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --card-bg: rgba(255, 255, 255, 0.65);
            --input-bg: rgba(255, 255, 255, 0.5);
            --border-color: rgba(0, 0, 0, 0.05);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 12px 24px rgba(0, 0, 0, 0.06);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            background-color: #f0f2f5;
            /* Premium Soft Mesh Gradient */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 90%, 1) 0, transparent 50%);
            background-size: 100% 100%;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Light Theme Override for Mesh */
        @media (prefers-color-scheme: light) {
            body {
                background-color: #ffffff;
                background-image:
                    radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 0%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 0%, hsla(343, 100%, 76%, 1) 0px, transparent 50%);
            }
        }

        /* Dark Mode Override if needed, but keeping light for now as requested */

        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: #1d1d1f;
            animation: fadeInUp 0.6s ease-out;
        }

        .section {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(30px);
            backdrop-filter: blur(30px);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: var(--glass-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.6s ease-out 0.1s backwards;
        }

        /* Interactive Section Hover */
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08);
        }

        .form-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        /* Staggered Animation Delays */
        .form-group:nth-child(1) {
            animation-delay: 0.15s;
        }

        .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .form-group:nth-child(3) {
            animation-delay: 0.25s;
        }

        .form-group:nth-child(4) {
            animation-delay: 0.3s;
        }

        .form-group:nth-child(5) {
            animation-delay: 0.35s;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 4px;
        }

        input,
        select {
            width: 100%;
            padding: 18px 18px 18px 50px;
            /* Increased padding for icon */
            border: 1px solid transparent;
            background: #F5F5F7;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            font-size: 17px;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-color);
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
            /* Mobile fixes */
            box-sizing: border-box;
            max-width: 100%;
        }

        /* Hide spin buttons */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Fix for Select Icon Overlap */
        select {
            padding-right: 50px;
            /* Increased right padding */
        }

        input:focus,
        select:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
            transform: translateY(-1px);
        }

        .input-wrapper {
            position: relative;
            transition: transform 0.2s ease;
        }

        .input-wrapper:hover {
            transform: translateY(-1px);
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            color: var(--secondary-text);
            pointer-events: none;
            transition: color 0.2s;
        }

        input:focus+.input-icon,
        input:focus~.input-icon,
        select:focus+.input-icon,
        .input-wrapper input:focus+.input-icon {
            color: var(--primary-color);
            opacity: 1;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: fadeInUp 0.6s ease-out backwards;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: scale(1.01);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-md);
            z-index: 2;
        }

        .item-header {
            background: rgba(255, 255, 255, 0.5);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .item-card.collapsed .item-body {
            display: none;
        }

        .item-card.collapsed .item-header {
            border-bottom: none;
            background: rgba(255, 255, 255, 0.8);
        }

        .item-header-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .item-summary {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 4px;
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }

        .item-card.collapsed .item-summary {
            display: block;
        }

        .item-body {
            padding: 24px;
        }

        .item-title {
            font-weight: 700;
            font-size: 17px;
            color: var(--text-color);
            /* Removed background pill style for cleaner look */
            /* Mobile text handling */
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .btn {
            padding: 18px;
            border-radius: var(--radius-lg);
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* Glass Button Style for Submit */
        .btn-primary {
            background: rgba(0, 122, 255, 0.85);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover {
            background: rgba(0, 122, 255, 0.95);
            box-shadow: 0 12px 28px rgba(0, 122, 255, 0.35);
            transform: translateY(-2px);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Validation Error */
        .invalid {
            border-color: var(--danger-color) !important;
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
            background: rgba(255, 59, 48, 0.05) !important;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            color: var(--primary-color);
            border: 1px solid rgba(0, 122, 255, 0.1);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .btn-remove {
            color: var(--danger-color);
            background: rgba(255, 59, 48, 0.1);
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-remove:hover {
            background: rgba(255, 59, 48, 0.2);
            transform: scale(1.02);
        }

        .photo-preview-container {
            margin-top: 16px;
            border-radius: 16px;
            overflow: hidden;
            overflow: hidden;
            background: rgba(0, 122, 255, 0.03);
            border: 2px dashed rgba(0, 0, 0, 0.1);
            position: relative;
            height: 200px;
            /* Increased height */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-preview-container:hover {
            border-color: var(--primary-color);
            background: rgba(0, 122, 255, 0.03);
        }

        .photo-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            z-index: 1;
            border-radius: 14px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
            color: var(--primary-color);
            opacity: 0.8;
            transition: transform 0.3s ease;
        }

        .photo-preview-container:hover .upload-icon {
            transform: scale(1.1);
            opacity: 1;
        }

        .upload-label {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            z-index: 2;
            transition: opacity 0.3s;
        }

        /* When preview is shown, hide label content but keep input clickable? 
           Actually, we want to see "Change photo" text. 
           Let's add a background to label when preview is active? */

        .btn-text {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .hint {
            font-size: 13px;
            color: var(--secondary-text);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            color: #86868b;
            font-size: 12px;
            text-align: center;
            margin-top: 4px;
            /* Better contrast for mobile */
            color: #666;
            font-size: 13px;
        }

        /* Tooltip Hint */
        .input-hint {
            /* Improved contrast */
            color: #666;
            font-size: 13px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.8;
        }

        .input-hint svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        /* Segmented Control Redesign */
        .segmented-control {
            display: flex;
            background: #EFEFF4;
            /* iOS Segmented Control BG */
            border-radius: 9px;
            padding: 2px;
            margin-bottom: 24px;
            position: relative;
            border: none;
        }

        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            color: #000;
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.2s ease;
            margin: 0;
            position: relative;
            z-index: 1;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .segmented-control input[type="radio"] {
            display: none;
        }

        .segmented-control input[type="radio"]:checked+label {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.05);
            font-weight: 700;
            color: #000;
            transform: scale(1.02);
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            z-index: 2;
        }

        /* Pulse Animation for Main Button */
        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 122, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
            }
        }

        .btn-pulse {
            animation: pulse-blue 2s infinite;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: #ffffff;
            margin: 15% auto;
            padding: 24px;
            border-radius: 24px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Error states */
        .input-error {
            border: 2px solid var(--danger-color) !important;
            animation: shake 0.3s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }

        .error-message.show {
            display: block;
        }

        /* Sticky submit button */
        /* Sticky footer container */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
        }

        .hint-text {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
            margin-left: 4px;
        }

        .upload-status {
            text-align: center;
            font-size: 13px;
            margin-top: 8px;
            color: var(--secondary-text);
        }

        .upload-status.success {
            color: var(--success-color);
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 16px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .draft-notice {
            background: rgba(52, 199, 89, 0.1);
            border-left: 3px solid var(--success-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--text-color);
            display: none;
        }

        .info-icon {
            border: 1.5px solid currentColor;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .info-icon:hover {
            opacity: 1;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.06) 25%, rgba(0, 0, 0, 0.12) 50%, rgba(0, 0, 0, 0.06) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 6px;
            display: inline-block;
            height: 14px;
            width: 140px;
            vertical-align: middle;
        }

        .stats-counter {
            text-align: center;
            color: var(--secondary-text);
            font-size: 13px;
            margin-top: -10px;
            margin-bottom: 20px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Preview Modal Styles */
        .preview-card {
            background: rgba(255, 255, 255, 0.5);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .preview-card.mode-test {
            background: rgba(255, 165, 0, 0.15);
            border-color: rgba(255, 165, 0, 0.3);
        }

        .preview-card.mode-final {
            background: rgba(52, 199, 89, 0.15);
            border-color: rgba(52, 199, 89, 0.3);
        }

        .preview-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--secondary-text);
            margin-bottom: 12px;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .preview-row:last-child {
            margin-bottom: 0;
        }

        .preview-label {
            color: var(--secondary-text);
            font-size: 13px;
        }

        .preview-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 15px;
            text-align: right;
        }

        .preview-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .preview-image {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .preview-item-content {
            flex: 1;
        }

        .preview-item-desc {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .preview-item-price {
            color: var(--secondary-text);
            font-size: 13px;
            margin-top: 2px;
        }
    </style>
</head>

<body>
    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 10px;">
        <h1 id="mainTitle" style="margin: 0;">–ù–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ</h1>
        <span class="info-icon" onclick="showUserGuide()" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">i</span>
    </div>

    <!-- Draft Notice -->
    <div class="draft-notice" id="draftNotice">
        ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="mainForm">
        <div class="section">
            <div class="form-group">
                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                <div class="input-wrapper">
                    <input type="tel" id="department" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 385" required pattern="\d+">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è</label>
                <div class="input-wrapper">
                    <input type="tel" id="issue" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" required pattern="\d+">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞</label>
                <div class="input-wrapper">
                    <input type="tel" id="ticket" placeholder="03850006392" required maxlength="11" inputmode="numeric"
                        pattern="[0-9]{11}">
                    <div class="error-message"></div>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 11V7a5 5 0 0 1 10 0v4"></path>
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <div class="hint-text">–†–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä</div>
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <div class="input-wrapper">
                    <input type="date" id="date" required max="" placeholder="–î–∞—Ç–∞" title="–î–∞—Ç–∞">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="hint-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –∏–ª–∏ –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É</div>
            </div>
            <div class="form-group">
                <label>–†–µ–≥–∏–æ–Ω</label>
                <div class="input-wrapper">
                    <select id="region" required aria-label="–†–µ–≥–∏–æ–Ω">
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                        <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                        <option value="–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                        <option value="–ë–∞—à–∫–∏—Ä–∏—è">–ë–∞—à–∫–∏—Ä–∏—è</option>
                        <option value="–¢—é–º–µ–Ω—å">–¢—é–º–µ–Ω—å</option>
                        <option value="–•–ú–ê–û-–Æ–≥—Ä–∞">–•–ú–ê–û-–Æ–≥—Ä–∞</option>
                        <option value="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</option>
                        <option value="–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫">–ß–µ–ª—è–±–∏–Ω—Å–∫</option>
                        <option value="–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫">–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫</option>
                        <option value="–ö—É—Ä–≥–∞–Ω">–ö—É—Ä–≥–∞–Ω</option>
                        <option value="–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
                    </select>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
            </div>
        </div>

        <div class="items-header">
            <div class="flex-space">
                <h3 class="section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                <span id="itemCountBadge" class="badge">1</span>
            </div>
            <div id="itemsList"></div>
            <button type="button" class="btn btn-secondary" onclick="addItem()">
                –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
            </button>
        </div>

        <!-- Mode Toggle (Moved to Bottom) -->
        <label class="mode-label">–†–µ–∂–∏–º –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
        <div class="segmented-control">
            <input type="radio" name="mode" id="mode-final" value="final" checked>
            <label for="mode-final">–û—Ä–∏–≥–∏–Ω–∞–ª (–í –≥—Ä—É–ø–ø—É)</label>

            <input type="radio" name="mode" id="mode-test" value="test">
            <label for="mode-test">–ß–µ—Ä–Ω–æ–≤–∏–∫ (–¢–µ—Å—Ç)</label>
        </div>

        <div class="sticky-footer">
            <button type="button" class="btn btn-primary" onclick="showPreview()">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>

        <div class="footer-note">
            <div style="opacity: 0.5; font-size: 10px; margin-bottom: 2px;">
                –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –ñ—É–∫–æ–≤—ã–º –û–ª–µ–≥–æ–º
            </div>
            <div style="font-size: 11px;">
                Version 2.5 - 2025-11-26
            </div>
        </div>
    </form>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2 class="no-margin-top">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            <div id="previewContent"></div>
            <div class="flex-gap">
                <button class="btn btn-secondary" onclick="closePreview()">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary btn-no-margin" onclick="submitForm()"
                    id="finalSubmitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="no-margin-top">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="form-group">
                <label>ImgBB API Key</label>
                <input type="text" id="apiKeyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —Å api.imgbb.com">
                <div class="hint-text">–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</div>
            </div>
            <div class="form-group">
                <label>URL –ë–æ—Ç–∞ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞)</label>
                <input type="text" id="botUrlInput" placeholder="https://... (ngrok/glitch)">
                <div class="hint-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–Ω—É—Ç—Ä–∏ Telegram</div>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary btn-margin-10"
                onclick="document.getElementById('settingsModal').style.display = 'none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        // --- CONFIGURATION ---
        // WARNING: These are default values for local/demo use.
        // For production, consider injecting these via environment variables or a build step.
        // --- SECURITY: XSS PROTECTION ---
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const APP_CONFIG = {
            DEFAULT_BOT_URL: window.APP_DEFAULT_BOT_URL || "",
            DEFAULT_IMGBB_KEY: window.APP_DEFAULT_IMGBB_KEY || ""  // ‚úÖ Removed hardcoded key for security
        };

        // Initialize
        tg.expand();
        // Assuming restoreDraft() exists elsewhere or will be added.
        // restoreDraft();

        // Load API Key (default to the provided one if not in storage)
        let imgbbKey = localStorage.getItem('imgbb_key') || APP_CONFIG.DEFAULT_IMGBB_KEY;

        // Load Bot URL (for standalone mode)
        let botUrl = localStorage.getItem('bot_url') || APP_CONFIG.DEFAULT_BOT_URL;

        // Secret Settings Access
        let titleClicks = 0;
        let titleTimer;

        function populateSettingsInputs() {
            document.getElementById('apiKeyInput').value = imgbbKey;
            document.getElementById('botUrlInput').value = botUrl;
        }

        function handleTitleClick() {
            titleClicks++;
            clearTimeout(titleTimer);
            titleTimer = setTimeout(() => {
                titleClicks = 0;
            }, 1000);

            if (titleClicks >= 5) {
                populateSettingsInputs();
                document.getElementById('settingsModal').style.display = 'block';
                titleClicks = 0;
            }
        }

        function showUserGuide() {
            const guide = `üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

1Ô∏è‚É£ –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è:
   ‚Ä¢ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
   ‚Ä¢ –ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è
   ‚Ä¢ –ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ (—Ä–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä)
   ‚Ä¢ –î–∞—Ç–∞
   ‚Ä¢ –†–µ–≥–∏–æ–Ω

2Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã:
   ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ–±—ã –∏ –º–µ—Ç–∞–ª–ª–∞
   ‚Ä¢ –û—Ü–µ–Ω–∫–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
   ‚Ä¢ –§–æ—Ç–æ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å)

3Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:
   ‚Ä¢ –û—Ä–∏–≥–∏–Ω–∞–ª ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É
   ‚Ä¢ –ß–µ—Ä–Ω–æ–≤–∏–∫ ‚Üí —Ç–æ–ª—å–∫–æ –≤–∞–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

4Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å"

üí° –°–û–í–ï–¢–´:
   ‚Ä¢ –ë–∏–ª–µ—Ç –∞–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –¥–∞—Ç—É –ø–æ—Å–ª–µ 11 —Ü–∏—Ñ—Ä
   ‚Ä¢ –ë–∏–ª–µ—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ –Ω–æ–≤—ã–π)
   ‚Ä¢ –†–µ–≥–∏–æ–Ω –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø–æ–º–∏–Ω–∞—é—Ç—Å—è
   ‚Ä¢ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏`;

            // Use alert() for browser compatibility
            alert(guide);
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const url = document.getElementById('botUrlInput').value.trim();

            if (key) {
                localStorage.setItem('imgbb_key', key);
                imgbbKey = key;
            } else {
                localStorage.removeItem('imgbb_key');
                imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY;
            }

            if (url) {
                // Remove trailing slash
                const cleanUrl = url.replace(/\/$/, "");
                localStorage.setItem('bot_url', cleanUrl);
                botUrl = cleanUrl;
            } else {
                localStorage.removeItem('bot_url');
                botUrl = APP_CONFIG.DEFAULT_BOT_URL;
            }

            document.getElementById('settingsModal').style.display = 'none';
            tg.showAlert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        }

        // Theme handling
        if (tg.themeParams) {
            const r = document.documentElement.style;
        }

        // Set today's date and max date (prevent future dates)
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date');
        dateInput.valueAsDate = new Date();
        dateInput.setAttribute('max', today);

        let itemCount = 0;

        // Swipe gesture support
        let touchStartX = 0;
        let touchStartY = 0;
        let currentCard = null;

        function handleTouchStart(e) {
            const card = e.currentTarget.closest('.item-card');
            if (!card) return;

            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentCard = card;
        }

        function handleTouchMove(e) {
            if (!currentCard) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const diffX = touchX - touchStartX;
            const diffY = touchY - touchStartY;

            // Only horizontal swipe
            if (Math.abs(diffX) > Math.abs(diffY) && diffX < -50) {
                currentCard.style.transform = `translateX(${diffX}px)`;
                currentCard.style.opacity = 1 + diffX / 200;
            }
        }

        function handleTouchEnd(e) {
            if (!currentCard) return;

            const touchX = e.changedTouches[0].clientX;
            const diffX = touchX - touchStartX;

            if (diffX < -100) {
                // Swipe threshold reached - delete
                currentCard.style.transition = 'transform 0.3s, opacity 0.3s';
                currentCard.style.transform = 'translateX(-100%)';
                currentCard.style.opacity = '0';

                setTimeout(() => {
                    currentCard.remove();
                    updateBadge();
                    haptic('medium');
                }, 300);
            } else {
                // Reset position
                currentCard.style.transition = 'transform 0.3s, opacity 0.3s';
                currentCard.style.transform = 'translateX(0)';
                currentCard.style.opacity = '1';
            }

            currentCard = null;
        }

        function addItem() {
            // Collapse existing items
            collapseAllItems();

            itemCount++;
            updateBadge();

            const div = document.createElement('div');
            div.className = 'item-card';
            div.id = `item-${itemCount}`;
            div.innerHTML = `
                <div class="item-header" onclick="toggleItem(this)">
                    <div class="item-header-info">
                        <span class="item-title">–ü—Ä–µ–¥–º–µ—Ç #${itemCount}</span>
                        <span class="item-summary"></span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${itemCount > 1 ? `
                        <button type="button" class="btn-remove" onclick="removeItem(this, event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>` : ''}
                    </div>
                </div>
                <div class="item-body">
                    <div class="form-group">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" class="desc item-field" placeholder="–ö–æ–ª—å—Ü–æ, –º–µ—Ç–∞–ª–ª –∂–µ–ª—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞" required>
                        <div class="error-message"></div>
                        <div class="input-hint">
                            –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø—Ä–æ–±—ã –∏ –≤–∏–¥–∞ –º–µ—Ç–∞–ª–ª–∞ (–∑–æ–ª–æ—Ç–æ/—Å–µ—Ä–µ–±—Ä–æ)
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–û—Ü–µ–Ω–∫–∞ (—Ä—É–±.)</label>
                        <input type="tel" class="eval item-field" placeholder="–°—É–º–º–∞" required inputmode="numeric">
                        <div class="error-message"></div>
                        <div class="input-hint">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤</div>
                    </div>
                    <div class="photo-preview-container" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event, this)"
                         ontouchstart="handleTouchStart(event)"
                         ontouchmove="handleTouchMove(event)"
                         ontouchend="handleTouchEnd(event)">
                        <div class="photo-preview"></div>
                        <label class="upload-label">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <input type="file" class="file-input" accept="image/*" onchange="handleFileSelect(this)" style="display:none">
                            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            <span class="hint">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ</span>
                        </label>
                    </div>
                    <div class="upload-status">–î–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω–æ —Ñ–æ—Ç–æ: –æ–±—â–∏–π –≤–∏–¥ –∏ –∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω –≤–∞–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π</div>
                </div>
            `;
            document.getElementById('itemsList').appendChild(div);
        }

        function removeItem(btn, event) {
            if (event) event.stopPropagation();
            btn.closest('.item-card').remove();
            updateBadge();
        }

        function collapseAllItems() {
            document.querySelectorAll('.item-card').forEach(card => {
                card.classList.add('collapsed');
                updateItemSummary(card);
            });
        }

        function updateItemSummary(card) {
            const desc = card.querySelector('.desc').value;
            const price = card.querySelector('.eval').value;
            const hasPhoto = card.querySelector('.file-input').files.length > 0;

            let summary = [];
            if (desc) summary.push(desc);
            if (price) {
                // Check if formatNumberWithSpaces exists (might not be loaded yet on initial load)
                if (typeof formatNumberWithSpaces === 'function') {
                    summary.push(formatNumberWithSpaces(price) + ' ‚ÇΩ');
                } else {
                    summary.push(price + ' ‚ÇΩ');
                }
            }
            if (hasPhoto) summary.push('üì∑ –§–æ—Ç–æ');

            const summaryText = summary.join(', ') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            card.querySelector('.item-summary').textContent = summaryText;
        }

        function toggleItem(header) {
            const card = header.closest('.item-card');
            if (card.classList.contains('collapsed')) {
                card.classList.remove('collapsed');
            } else {
                card.classList.add('collapsed');
                updateItemSummary(card);
            }
        }

        function updateBadge() {
            const count = document.getElementById('itemsList').children.length;
            document.getElementById('itemCountBadge').textContent = count;
        }

        // --- UX Features ---

        // 1. Drag & Drop
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.style.borderColor = 'var(--primary-color)';
            e.currentTarget.style.background = 'rgba(0, 122, 255, 0.05)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.style.borderColor = 'rgba(0, 0, 0, 0.1)';
            e.currentTarget.style.background = 'rgba(0, 0, 0, 0.03)';
        }

        function handleDrop(e, container) {
            e.preventDefault();
            e.stopPropagation();

            container.style.borderColor = 'rgba(0, 0, 0, 0.1)';
            container.style.background = 'rgba(0, 0, 0, 0.03)';

            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files[0]) {
                const fileInput = container.querySelector('.file-input');
                fileInput.files = files;
                handleFileSelect(fileInput);
            }
        }

        // 3. Input Mask for Ticket (Digits only, max 11) + Auto-focus
        document.getElementById('ticket').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 11);

            // \u2705 UX: Auto-focus to date field when 11 digits entered
            if (e.target.value.length === 11) {
                document.getElementById('date').focus();
            }
        });

        // Input Mask for Department and Issue (Digits only)
        ['department', 'issue'].forEach(id => {
            document.getElementById(id).addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });

        // Auto-save on input
        ['department', 'issue', 'ticket', 'date', 'region'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', saveDraft);
        });

        // Restore draft on load
        restoreDraft();

        // ============================================
        // SERVICE WORKER & OFFLINE MODE
        // ============================================
        if ('serviceWorker' in navigator) {
            const swVersion = '2303';
            const basePath = location.pathname.endsWith('/') ? location.pathname : `${location.pathname}/`;
            const swUrl = `${basePath}service-worker.js?v=${swVersion}`;
            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.error('Service Worker registration failed:', err));
        }

        // Offline queue using IndexedDB
        async function openOfflineDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ReportsDB', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('pending')) {
                        db.createObjectStore('pending', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function savePendingReport(data) {
            try {
                const db = await openOfflineDB();
                const tx = db.transaction('pending', 'readwrite');
                const store = tx.objectStore('pending');
                await store.add({ data, timestamp: Date.now() });
                console.log('Report saved to offline queue');
                return true;
            } catch (error) {
                console.error('Failed to save to offline queue:', error);
                return false;
            }
        }

        // Online event - sync pending reports
        window.addEventListener('online', async () => {
            console.log('Connection restored, syncing...');
            tg.showAlert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');

            try {
                const db = await openOfflineDB();
                const tx = db.transaction('pending', 'readonly');
                const store = tx.objectStore('pending');
                const pending = await store.getAll();

                if (pending.length > 0) {
                    for (const item of pending) {
                        try {
                            await submitData(item.data);
                            // Remove from queue after successful send
                            const deleteTx = db.transaction('pending', 'readwrite');
                            await deleteTx.objectStore('pending').delete(item.id);
                        } catch (error) {
                            console.error('Failed to sync report:', error);
                        }
                    }
                    tg.showAlert(`üéâ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${pending.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π!`);
                }
            } catch (error) {
                console.error('Failed to sync:', error);
            }
        });

        // Offline event notification
        window.addEventListener('offline', () => {
            console.log('Connection lost');
            tg.showAlert('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
        });

        // 4. Smart Memory (Department & Region)
        const deptInput = document.getElementById('department');
        const regionInput = document.getElementById('region');

        // Load defaults if not draft
        if (!localStorage.getItem('formDraft')) {
            const savedDept = localStorage.getItem('default_department');
            const savedRegion = localStorage.getItem('default_region');
            if (savedDept) deptInput.value = savedDept;
            if (savedRegion) regionInput.value = savedRegion;
        }

        // Save on change
        deptInput.addEventListener('change', (e) => {
            localStorage.setItem('default_department', e.target.value);
        });

        regionInput.addEventListener('change', (e) => {
            localStorage.setItem('default_region', e.target.value);
        });

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (5MB limit)
            const maxSize = 5 * 1024 * 1024; // 5 MB
            if (file.size > maxSize) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                tg.showAlert(`‚ö†Ô∏è –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (${sizeMB} –ú–ë). –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë. –û–Ω–æ –±—É–¥–µ—Ç —Å–∂–∞—Ç–æ.`);
                haptic('warning');
            }

            const container = input.closest('.item-card');
            const preview = container.querySelector('.photo-preview');
            const btnText = container.querySelector('.btn-text');
            const status = container.querySelector('.upload-status');

            // Preview
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.style.display = 'block';
                btnText.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ";
                status.textContent = file.size > maxSize ? "‚ö†Ô∏è –ë—É–¥–µ—Ç —Å–∂–∞—Ç–æ" : "–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ";
                status.className = "upload-status success";
            };
            reader.readAsDataURL(file);
        }

        // 5. Telegram Native UI & Haptic Feedback
        const mainButton = tg.MainButton;

        function updateMainButton() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                // We are in Telegram
                document.getElementById('finalSubmitBtn').style.display = 'none'; // Hide HTML button in modal
                document.querySelector('.btn-primary[onclick="showPreview()"]').style.display = 'none'; // Hide main form button

                mainButton.setText("–ü–†–û–í–ï–†–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨");
                mainButton.show();
                mainButton.onClick(showPreview);
            }
        }

        // Call on load
        updateMainButton();

        // Haptic Feedback Helper
        function haptic(type = 'light') {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred(type);
            }
        }

        // Add haptic to interactive elements
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('focus', () => haptic('light'));
        });

        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', () => haptic('medium'));
        });

        function showPreview() {
            haptic('medium');
            // Centralized validation
            if (!validateForm()) {
                return;
            }

            // Check photos
            let allPhotosSelected = true;
            document.querySelectorAll('.item-card').forEach(div => {
                const input = div.querySelector('.file-input');
                if (!input.files || !input.files[0]) {
                    allPhotosSelected = false;
                    const container = div.querySelector('.photo-preview-container');
                    container.style.borderColor = 'var(--danger-color)';
                    container.style.animation = 'shake 0.4s cubic-bezier(.36, .07, .19, .97) both';
                    haptic('error');

                    // Remove error on click/drop
                    input.addEventListener('change', () => {
                        container.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        container.style.animation = 'none';
                    }, { once: true });
                }
            });

            if (!allPhotosSelected) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤!");
                return;
            }

            const isTest = document.getElementById('mode-test').checked;
            const modeText = isTest ? "–ß–µ—Ä–Ω–æ–≤–∏–∫ (–¢–µ—Å—Ç)" : "–û—Ä–∏–≥–∏–Ω–∞–ª (–í –≥—Ä—É–ø–ø—É)";
            const modeExplanation = isTest
                ? "–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∞–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏."
                : "–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞–±–æ—á–∏–π —á–∞—Ç. –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ–ª—å–∑—è.";

            // Calculate total cost (remove spaces before parsing)
            let totalCost = 0;
            const items = [];
            document.querySelectorAll('.item-card').forEach(div => {
                const evalInput = div.querySelector('.eval');
                const descInput = div.querySelector('.desc');
                if (evalInput && evalInput.value) {
                    // Remove spaces and parse
                    const cleanValue = evalInput.value.replace(/\s/g, '');
                    const price = parseInt(cleanValue) || 0;
                    totalCost += price;
                    items.push({
                        desc: descInput.value,
                        price: price
                    });
                }
            });

            // Get ticket value
            const ticketValue = document.getElementById('ticket').value;

            // Build items list
            let itemsList = '';
            items.forEach((item, idx) => {
                // Get image preview URL
                const fileInput = document.querySelectorAll('.item-card')[idx].querySelector('.file-input');
                const file = fileInput.files[0];
                const imgUrl = file ? URL.createObjectURL(file) : '';
                const imgTag = imgUrl ? `<img src="${imgUrl}" class="preview-image">` : '<div class="preview-image"></div>';

                itemsList += `
                    <div class="preview-item">
                        ${imgTag}
                        <div class="preview-item-content">
                            <div class="preview-item-desc">#${idx + 1} ${escapeHtml(item.desc)}</div>
                            <div class="preview-item-price">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                        </div>
                    </div>
                `;
            });

            // Format Date
            const dateValue = document.getElementById('date').value;
            const dateParts = dateValue.split('-');
            const formattedDate = dateParts.length === 3 ? `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}` : dateValue;

            // Build preview with better structure
            const content = document.getElementById('previewContent');
            content.innerHTML = `
                <!-- Mode Section -->
                <div class="preview-card ${isTest ? 'mode-test' : 'mode-final'}">
                    <div class="preview-section-title" style="color: ${isTest ? '#FF8C00' : '#28a745'}; margin-bottom: 6px;">
                        –†–µ–∂–∏–º: ${modeText}
                    </div>
                    <div style="font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${modeExplanation}</div>
                </div>

                <!--Main Data Section-->
                <div class="preview-card">
                    <div class="preview-section-title">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
                    <div class="preview-row">
                        <span class="preview-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span>
                        <span class="preview-value">${escapeHtml(document.getElementById('department').value)}</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">–†–µ–≥–∏–æ–Ω:</span>
                        <span class="preview-value">${escapeHtml(document.getElementById('region').value)}</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">–î–∞—Ç–∞:</span>
                        <span class="preview-value">${escapeHtml(formattedDate)}</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">‚Ññ –∑–∞–∫–ª—é—á–µ–Ω–∏—è:</span>
                        <span class="preview-value">${escapeHtml(document.getElementById('issue').value)}</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">‚Ññ –±–∏–ª–µ—Ç–∞:</span>
                        <span class="preview-value" style="font-family: 'Inter', sans-serif;">${escapeHtml(ticketValue)}</span>
                    </div>
                </div>

                <!--Items Section-->
                <div class="preview-card">
                    <div class="preview-section-title">–ü—Ä–µ–¥–º–µ—Ç—ã (${items.length})</div>
                    ${itemsList}
                </div>

                <!--Total Section-->
                <div class="preview-card mode-final" style="margin-bottom: 0;">
                    <div class="preview-row">
                        <span class="preview-value" style="color: #000;">üí∞ –û–±—â–∞—è —Å—É–º–º–∞:</span>
                        <span class="preview-value" style="color: var(--success-color); font-size: 20px;">${totalCost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                </div>
            `;

            document.getElementById('previewModal').style.display = 'block';

            // Update Main Button for Submit
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                mainButton.setText("–û–¢–ü–†–ê–í–ò–¢–¨");
                mainButton.offClick(showPreview);
                mainButton.onClick(submitForm);
            }
        }

        function closePreview() {
            haptic('light');
            document.getElementById('previewModal').style.display = 'none';

            // Revert Main Button
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                mainButton.setText("–ü–†–û–í–ï–†–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨");
                mainButton.offClick(submitForm);
                mainButton.onClick(showPreview);
            }
        }

        // Image Compression Helper
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 1280;
                const maxHeight = 1280;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(function (blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.8); // 80% quality
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function submitForm() {
            // Disable button
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                mainButton.showProgress();
                mainButton.disable();
            }

            const btn = document.getElementById('finalSubmitBtn');
            btn.disabled = true;
            btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB...";

            const items = [];
            const cards = document.querySelectorAll('.item-card');

            // Upload photos one by one to ImgBB
            for (let i = 0; i < cards.length; i++) {
                const div = cards[i];
                const fileInput = div.querySelector('.file-input');
                const file = fileInput.files[0];

                // Skip if no file selected
                if (!file) {
                    console.warn(`Skipping item ${i + 1} - no photo selected`);
                    continue;
                }

                // Update progress
                updateProgress(i, cards.length);
                btn.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ ${i + 1}/${cards.length}...`;

                try {
                    // Compress first
                    const compressedBlob = await compressImage(file);

                    const formData = new FormData();
                    formData.append('image', compressedBlob, 'image.jpg');
                    formData.append('key', imgbbKey);

                    const response = await fetch('https://api.imgbb.com/1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result && result.data && result.data.url) {
                        items.push({
                            description: div.querySelector('.desc').value,
                            evaluation: div.querySelector('.eval').value,
                            photo_url: result.data.url
                        });
                    } else {
                        throw new Error("ImgBB Error: " + (result.error ? result.error.message : "Unknown error"));
                    }

                } catch (e) {
                    console.error("Upload failed", e);
                    tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message || e}`);
                    haptic('error');

                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        mainButton.hideProgress();
                        mainButton.enable();
                    }

                    btn.disabled = false;
                    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                    return;
                }
            }

            btn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

            try {
                const isTest = document.getElementById('mode-test').checked;

                const data = {
                    department_number: document.getElementById('department').value,
                    issue_number: document.getElementById('issue').value,
                    ticket_number: document.getElementById('ticket').value,
                    date: document.getElementById('date').value.split('-').reverse().join('.'),
                    region: document.getElementById('region').value,
                    items: items,
                    is_test: isTest
                };

                // Check if running in Telegram
                // iOS Telegram 9.x bug: initData may be empty even in WebApp
                // Instead, check for platform/version which are always present in Telegram
                console.log('tg.platform:', tg.platform);
                console.log('tg.version:', tg.version);
                console.log('tg.initData:', tg.initData);
                console.log('tg.initDataUnsafe:', tg.initDataUnsafe);

                // Check if we're in Telegram by platform/version presence
                const isInTelegram = (tg.platform && tg.platform.length > 0) ||
                    (tg.version && tg.version.length > 0) ||
                    (tg.initData && tg.initData.length > 0);

                if (isInTelegram) {
                    console.log('Detected Telegram WebApp - sending via tg.sendData()');
                    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...";
                    tg.sendData(JSON.stringify(data));
                    haptic('success');

                    // ‚úÖ UX: Clear ticket for next form (always unique)
                    document.getElementById('ticket').value = '';
                    clearDraft();

                    // Close WebApp after sending data
                    setTimeout(() => tg.close(), 100);
                } else {
                    // Standalone Mode
                    if (!botUrl) {
                        populateSettingsInputs();
                        document.getElementById('settingsModal').style.display = 'block';
                        tg.showAlert("–î–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å URL –±–æ—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ngrok –∞–¥—Ä–µ—Å).");
                        btn.disabled = false;
                        btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                        return;
                    }

                    btn.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...";

                    // Add timeout to fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                    const response = await fetch(botUrl + '/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        btn.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...";
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.error || `Server Error: ${response.status}`);
                    }

                    btn.textContent = "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...";

                    // Download File
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Conclusion_${data.ticket_number}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    clearDraft();

                    // ‚úÖ UX: Clear ticket for next form (always unique)
                    document.getElementById('ticket').value = '';

                    alert("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∏ —Å–∫–∞—á–∞–Ω!");
                    closePreview();
                    btn.disabled = false;
                    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                }
            } catch (e) {
                console.error("Submission Error", e);
                haptic('error');

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    mainButton.hideProgress();
                    mainButton.enable();
                }

                if (e.name === 'AbortError') {
                    alert("–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30—Å). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ URL –±–æ—Ç–∞.");
                } else {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${e.message}`);
                }
                btn.disabled = false;
                btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            }
        }

        // Initial item
        addItem();

        // ============================================
        // AUTO-SAVE DRAFT & RESTORE
        // ============================================
        function saveDraft() {
            const draft = {
                department: document.getElementById('department').value,
                issue: document.getElementById('issue').value,
                // ticket: excluded - always unique per form
                date: document.getElementById('date').value,
                region: document.getElementById('region').value,
                timestamp: Date.now()
            };
            localStorage.setItem('formDraft', JSON.stringify(draft));
        }

        function restoreDraft() {
            const draftStr = localStorage.getItem('formDraft');
            if (!draftStr) return;

            const draft = JSON.parse(draftStr);
            // Only restore if draft is less than 24 hours old
            const hoursSinceLastSave = (Date.now() - draft.timestamp) / (1000 * 60 * 60);
            if (hoursSinceLastSave > 24) {
                localStorage.removeItem('formDraft');
                return;
            }

            // Restore values (ticket excluded - always unique)
            if (draft.department) document.getElementById('department').value = draft.department;
            if (draft.issue) document.getElementById('issue').value = draft.issue;
            // if (draft.ticket) document.getElementById('ticket').value = draft.ticket;  // ‚ùå Never restore
            if (draft.date) document.getElementById('date').value = draft.date;
            if (draft.region) document.getElementById('region').value = draft.region;

            // Show notice
            const notice = document.getElementById('draftNotice');
            notice.style.display = 'block';
            setTimeout(() => {
                notice.style.opacity = '0';
                notice.style.transition = 'opacity 1s';
                setTimeout(() => notice.style.display = 'none', 1000);
            }, 3000);
        }

        function clearDraft() {
            localStorage.removeItem('formDraft');
        }

        // Update progress bar
        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const percent = (current / total) * 100;

            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';

            if (current === total) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        // Auto-save every 2 seconds
        setInterval(saveDraft, 2000);

        // Restore draft on page load
        restoreDraft();

        // Add item (with numbering)
        let itemCounter = 1;
    </script>
    <script src="ux-improvements.js"></script>
</body>

</html>