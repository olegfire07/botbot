# Modern Bot

Это улучшенная и переработанная версия бота для создания заключений, включающая режим веб-приложения (Mini App).

## Возможности
- **Модульная структура**: Чистый код, организованный в папке `modern_bot/`.
- **Веб-приложение**: Удобный ввод данных через Telegram Mini App с защитой от ошибок.
- **Автономный режим**: Возможность использовать веб-приложение в любом браузере (Chrome, Safari) для генерации документов без Telegram.
- **Монетизация**: Команда `/broadcast` для рассылки сообщений всем пользователям.
- **Улучшенные отчеты**: Усовершенствованная работа с архивами и статистикой.

## Как запустить
1.  Убедитесь, что вы находитесь в корне проекта (`/Users/oleg/Project_SKLAD`).
2.  Запустите бота:
    ```bash
    python3 run_modern_bot.py
    ```
3.  **Для автономного режима**: Запустите туннель ngrok:
    ```bash
    ./start_tunnel.sh
    ```
    *Примечание: URL по умолчанию в `index.html` настроен на конкретный адрес ngrok. Если ваш URL туннеля изменится, вам нужно будет обновить его в настройках веб-приложения.*

## Настройка веб-приложения
Чтобы использовать веб-приложение:
1.  Актуальная версия мини-приложения лежит в корне репозитория (`web_app/index.html`). Копия в `modern_bot/web_app/` синхронизируется автоматически и используется как запасная.
2.  Разместите файл `web_app/index.html` на публичном сервере (например, GitHub Pages).
3.  **Автономный доступ**: Откройте URL GitHub Pages прямо в браузере.
    - Если "URL бота" не настроен или неверен, приложение предложит вам ввести его (например, ваш URL ngrok).
    - **Секретные настройки**: Нажмите на заголовок "Новое заключение" 5 раз подряд, чтобы открыть настройки вручную.

## Команды администратора
- `/add_admin <ID>`
- `/broadcast <Сообщение>`
- `/download_month <ММ.ГГГГ>`
- `/stats`

## Архитектура и потоки данных

### Поток настроек и конфигурации
```mermaid
sequenceDiagram
    actor "Пользователь" as User
    participant "Заголовок" as MainTitle
    participant "Модальное окно настроек" as SettingsModal
    participant "Локальное хранилище" as LocalStorage
    participant "Конфигурация приложения" as AppConfig

    "Пользователь"->>"Заголовок": "Клик по заголовку (x5)"
    "Заголовок"->>"Заголовок": "Увеличение счетчика кликов"
    "Заголовок"-->>"Заголовок": "Кликов >= 5?"
    alt "Достигнуто 5 кликов"
        "Заголовок"->>"Модальное окно настроек": "Показать окно настроек"
        "Модальное окно настроек"->>"Локальное хранилище": "Чтение 'imgbb_key' и 'bot_url' (уже загружены в переменные)"
        "Модальное окно настроек"->>"Модальное окно настроек": "Установить 'apiKeyInput.value' = imgbbKey"
        "Модальное окно настроек"->>"Модальное окно настроек": "Установить 'botUrlInput.value' = botUrl"
        "Заголовок"->>"Заголовок": "Сброс счетчика кликов в 0"
    end

    "Пользователь"->>"Модальное окно настроек": "Редактирование ключа ImgBB и URL бота"
    "Пользователь"->>"Модальное окно настроек": "Клик по кнопке 'Сохранить'"
    "Модальное окно настроек"->>"Модальное окно настроек": "saveSettings() читает apiKeyInput, botUrlInput"

    alt "Ключ ImgBB не пустой"
        "Модальное окно настроек"->>"Локальное хранилище": "Установить 'imgbb_key' = ключ"
        "Модальное окно настроек"->>"Модальное окно настроек": "imgbbKey = ключ"
    else "Ключ ImgBB пустой"
        "Модальное окно настроек"->>"Локальное хранилище": "Удалить 'imgbb_key'"
        "Модальное окно настроек"->>"Конфигурация приложения": "Чтение DEFAULT_IMGBB_KEY"
        "Модальное окно настроек"->>"Модальное окно настроек": "imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY"
    end

    alt "Ввод URL бота не пустой"
        "Модальное окно настроек"->>"Модальное окно настроек": "cleanUrl = url без слеша в конце"
        "Модальное окно настроек"->>"Локальное хранилище": "Установить 'bot_url' = cleanUrl"
        "Модальное окно настроек"->>"Модальное окно настроек": "botUrl = cleanUrl"
    else "Ввод URL бота пустой или не определен"
        "Модальное окно настроек"->>"Локальное хранилище": "Удалить 'bot_url'"
        "Модальное окно настроек"->>"Конфигурация приложения": "Чтение DEFAULT_BOT_URL"
        "Модальное окно настроек"->>"Модальное окно настроек": "botUrl = APP_CONFIG.DEFAULT_BOT_URL"
    end

    "Модальное окно настроек"->>"Модальное окно настроек": "Скрыть окно настроек"
```

### Поток отправки данных
```mermaid
sequenceDiagram
    actor "Пользователь" as User
    participant "Главная форма" as MainForm
    participant "Telegram WebApp" as Telegram
    participant "Модальное окно настроек" as SettingsModal
    participant "Локальное хранилище" as LocalStorage
    participant "Бэкенд бота" as BotBackend

    "Пользователь"->>"Главная форма": "Клик 'Проверить и отправить'"
    "Главная форма"->>"Главная форма": "showPreview() и подготовка объекта данных"

    "Пользователь"->>"Главная форма": "Подтверждение отправки"
    "Главная форма"->>"Главная форма": "Отключение кнопки отправки, текст 'Отправка...'"

    "Главная форма"->>"Telegram": "Проверка tg.initDataUnsafe и tg.initDataUnsafe.user"
    alt "Запущено внутри Telegram"
        "Главная форма"->>"Telegram": "tg.sendData(JSON.stringify(data))"
        "Telegram"-->>"Главная форма": "Отправка боту через платформу Telegram"
        "Главная форма"->>"Главная форма": "Включение интерфейса при необходимости"
    else "Автономный режим в браузере"
        "Главная форма"->>"Главная форма": "Проверка значения botUrl"
        alt "botUrl пустой или отсутствует"
            "Главная форма"->>"Модальное окно настроек": "Показать окно настроек"
            "Главная форма"->>"Telegram": "tg.showAlert('Нужно указать URL бота...')"
            "Главная форма"->>"Главная форма": "Включение кнопки отправки, текст 'Отправить'"
        else "botUrl настроен"
            "Главная форма"->>"Бэкенд бота": "Отправка данных на botUrl (HTTP запрос)"
            "Бэкенд бота"-->>"Главная форма": "Ответ с успехом или ошибкой"
            "Главная форма"->>"Главная форма": "Обработка ответа, включение кнопки отправки"
        end
    end
```

### Логика инициализации
```mermaid
flowchart TD
    A_Start["Запуск приложения"]
    A_Start-->A_LoadImgBB["Загрузка 'imgbb_key' из локального хранилища"]
    A_LoadImgBB-->A_ImgBBExists{"'imgbb_key' существует?"}
    A_ImgBBExists-->|"Да"|A_SetImgBBFromStorage["Установить imgbbKey = сохраненное значение"]
    A_ImgBBExists-->|"Нет"|A_SetImgBBDefault["Установить imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY"]

    A_SetImgBBFromStorage-->A_LoadBotUrl["Загрузка 'bot_url' из локального хранилища"]
    A_SetImgBBDefault-->A_LoadBotUrl
    A_LoadBotUrl-->A_BotUrlExists{"'bot_url' существует?"}
    A_BotUrlExists-->|"Да"|A_SetBotUrlFromStorage["Установить botUrl = сохраненное значение"]
    A_BotUrlExists-->|"Нет"|A_SetBotUrlDefault["Установить botUrl = APP_CONFIG.DEFAULT_BOT_URL"]

    A_SetBotUrlFromStorage-->A_Wait["Ожидание действий пользователя"]
    A_SetBotUrlDefault-->A_Wait

    subgraph B_Settings_Modal_Open ["B_Открытие окна настроек"]
        B_Open["Пользователь кликает по заголовку 5 раз"]-->B_ShowModal["Показать окно настроек"]
        B_ShowModal-->B_Prefill["Заполнить apiKeyInput = imgbbKey, botUrlInput = botUrl"]
    end

    A_Wait-->B_Open

    subgraph C_Save_Settings ["C_Сохранение настроек"]
        C_UserSave["Пользователь кликает 'Сохранить'"]-->C_ReadInputs["Чтение apiKeyInput и botUrlInput"]
        C_ReadInputs-->C_ImgBBNonEmpty{"Ключ ImgBB не пустой?"}
        C_ImgBBNonEmpty-->|"Да"|C_SaveImgBB["Сохранить 'imgbb_key' в локальное хранилище и установить imgbbKey = ключ"]
        C_ImgBBNonEmpty-->|"Нет"|C_ResetImgBB["Удалить 'imgbb_key'; установить imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY"]

        C_SaveImgBB-->C_BotUrlNonEmpty{"URL бота не пустой?"}
        C_ResetImgBB-->C_BotUrlNonEmpty
        C_BotUrlNonEmpty-->|"Да"|C_CleanAndSaveUrl["Удалить слеш в конце; сохранить 'bot_url'; установить botUrl = cleanUrl"]
        C_BotUrlNonEmpty-->|"Нет"|C_ResetBotUrl["Удалить 'bot_url'; установить botUrl = APP_CONFIG.DEFAULT_BOT_URL"]

        C_CleanAndSaveUrl-->C_CloseModal["Скрыть окно настроек"]
        C_ResetBotUrl-->C_CloseModal
    end

    B_Prefill-->C_UserSave
    C_CloseModal-->A_Wait
```
