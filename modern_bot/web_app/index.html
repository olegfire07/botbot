<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover: #0062cc;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --card-bg: rgba(255, 255, 255, 0.65);
            --input-bg: rgba(255, 255, 255, 0.5);
            --border-color: rgba(0, 0, 0, 0.05);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 12px 24px rgba(0, 0, 0, 0.06);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            background-color: #f0f2f5;
            /* Premium Soft Mesh Gradient */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 90%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 90%, 1) 0, transparent 50%);
            background-size: 100% 100%;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Light Theme Override for Mesh */
        @media (prefers-color-scheme: light) {
            body {
                background-color: #ffffff;
                background-image:
                    radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 0%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 0%, hsla(343, 100%, 76%, 1) 0px, transparent 50%);
            }
        }

        /* Dark Mode Override if needed, but keeping light for now as requested */

        h1 {
            text-align: center;
            margin-bottom: 24px;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: #1d1d1f;
            animation: fadeInUp 0.6s ease-out;
        }

        .section {
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: var(--glass-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.6s ease-out 0.1s backwards;
        }

        /* Interactive Section Hover */
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.08);
        }

        .form-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        /* Staggered Animation Delays */
        .form-group:nth-child(1) {
            animation-delay: 0.15s;
        }

        .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .form-group:nth-child(3) {
            animation-delay: 0.25s;
        }

        .form-group:nth-child(4) {
            animation-delay: 0.3s;
        }

        .form-group:nth-child(5) {
            animation-delay: 0.35s;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 4px;
        }

        input,
        select {
            width: 100%;
            padding: 18px 18px 18px 50px;
            /* Increased padding for icon */
            border: 1px solid transparent;
            background: #F5F5F7;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-md);
            font-size: 17px;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-color);
            box-shadow: none;
            appearance: none;
            -webkit-appearance: none;
            /* Mobile fixes */
            box-sizing: border-box;
            max-width: 100%;
        }

        /* Hide spin buttons */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Fix for Select Icon Overlap */
        select {
            padding-right: 50px;
            /* Increased right padding */
        }

        /* Disable browser's native invalid styling - AGGRESSIVE */
        input:invalid,
        select:invalid,
        textarea:invalid {
            box-shadow: none !important;
            border-color: rgba(0, 0, 0, 0.12) !important;
            outline: none !important;
            background: #fafafa !important;
        }

        /* Force remove any red styling from invalid inputs */
        input:required:invalid,
        select:required:invalid,
        textarea:required:invalid {
            box-shadow: none !important;
            border-color: rgba(0, 0, 0, 0.12) !important;
            outline: none !important;
        }

        /* Override :invalid styles when user is actively editing */
        input.user-editing:invalid,
        select.user-editing:invalid,
        textarea.user-editing:invalid {
            box-shadow: none !important;
            border-color: rgba(0, 0, 0, 0.12) !important;
            outline: none !important;
            background: #fafafa !important;
        }

        /* Ensure .user-editing also removes .invalid styling */
        input.user-editing,
        select.user-editing,
        textarea.user-editing {
            border-color: rgba(0, 0, 0, 0.12) !important;
            background: #fafafa !important;
            animation: none !important;
        }

        /* CRITICAL: Override .invalid class when user is editing - highest specificity */
        input.user-editing.invalid,
        select.user-editing.invalid,
        textarea.user-editing.invalid,
        input.user-editing:invalid,
        select.user-editing:invalid,
        textarea.user-editing:invalid {
            border-color: rgba(0, 0, 0, 0.12) !important;
            background: #fafafa !important;
            animation: none !important;
            box-shadow: none !important;
        }

        input:focus,
        select:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
            transform: translateY(-1px);
        }

        .input-wrapper {
            position: relative;
            transition: transform 0.2s ease;
        }

        .input-wrapper:hover {
            transform: translateY(-1px);
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            color: var(--secondary-text);
            pointer-events: none;
            transition: color 0.2s;
        }

        input:focus+.input-icon,
        input:focus~.input-icon,
        select:focus+.input-icon,
        .input-wrapper input:focus+.input-icon {
            color: var(--primary-color);
            opacity: 1;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: fadeInUp 0.6s ease-out backwards;
            position: relative;
            overflow: hidden;
        }

        .item-card:hover {
            transform: scale(1.01);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-md);
            z-index: 2;
        }

        .item-header {
            background: rgba(255, 255, 255, 0.5);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .item-card.collapsed .item-body {
            display: none;
        }

        .item-card.collapsed .item-header {
            border-bottom: none;
            background: rgba(255, 255, 255, 0.8);
        }

        .item-header-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .item-summary {
            font-size: 13px;
            color: var(--secondary-text);
            margin-top: 4px;
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }

        .item-card.collapsed .item-summary {
            display: block;
        }

        .item-body {
            padding: 24px;
        }

        .item-title {
            font-weight: 700;
            font-size: 17px;
            color: var(--text-color);
            /* Removed background pill style for cleaner look */
            /* Mobile text handling */
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .btn {
            padding: 18px;
            border-radius: var(--radius-lg);
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.01em;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* Glass Button Style for Submit */
        .btn-primary {
            background: rgba(0, 122, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover {
            background: rgba(0, 122, 255, 0.95);
            box-shadow: 0 12px 28px rgba(0, 122, 255, 0.35);
            transform: translateY(-2px);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Validation Error */
        .invalid {
            border-color: var(--danger-color) !important;
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
            background: rgba(255, 59, 48, 0.05) !important;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            color: var(--primary-color);
            border: 1px solid rgba(0, 122, 255, 0.1);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .btn-remove {
            color: var(--danger-color);
            background: rgba(255, 59, 48, 0.1);
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-remove:hover {
            background: rgba(255, 59, 48, 0.2);
            transform: scale(1.02);
        }

        .photo-preview-container {
            margin-top: 16px;
            border-radius: 16px;
            overflow: hidden;
            overflow: hidden;
            background: rgba(0, 122, 255, 0.03);
            border: 2px dashed rgba(0, 0, 0, 0.1);
            position: relative;
            height: 200px;
            /* Increased height */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-preview-container:hover {
            border-color: var(--primary-color);
            background: rgba(0, 122, 255, 0.03);
        }

        .photo-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            z-index: 1;
            border-radius: 14px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
            color: var(--primary-color);
            opacity: 0.8;
            transition: transform 0.3s ease;
        }

        .photo-preview-container:hover .upload-icon {
            transform: scale(1.1);
            opacity: 1;
        }

        .upload-label {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            z-index: 2;
            transition: opacity 0.3s;
        }

        /* When preview is shown, hide label content but keep input clickable? 
           Actually, we want to see "Change photo" text. 
           Let's add a background to label when preview is active? */

        .btn-text {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .hint {
            font-size: 13px;
            color: var(--secondary-text);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            color: #86868b;
            font-size: 12px;
            text-align: center;
            margin-top: 4px;
            /* Better contrast for mobile */
            color: #666;
            font-size: 13px;
        }

        /* Tooltip Hint */
        .input-hint {
            /* Improved contrast */
            color: #666;
            font-size: 13px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.8;
        }

        .input-hint svg {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        /* Segmented Control Redesign */
        .segmented-control {
            display: flex;
            background: #EFEFF4;
            /* iOS Segmented Control BG */
            border-radius: 9px;
            padding: 2px;
            margin-bottom: 24px;
            position: relative;
            border: none;
        }

        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            color: #000;
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.2s ease;
            margin: 0;
            position: relative;
            z-index: 1;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .segmented-control input[type="radio"] {
            display: none;
        }

        .segmented-control input[type="radio"]:checked+label {
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.05);
            font-weight: 700;
            color: #000;
            transform: scale(1.02);
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            z-index: 2;
        }

        /* Pulse Animation for Main Button */
        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 122, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
            }
        }

        .btn-pulse {
            animation: pulse-blue 2s infinite;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: #ffffff;
            margin: 15% auto;
            padding: 24px;
            border-radius: 24px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Error states */
        .input-error {
            border: 2px solid var(--danger-color) !important;
            animation: shake 0.3s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }

        .error-message.show {
            display: block;
        }

        /* Sticky submit button */
        /* Sticky footer container */
        .sticky-footer {
            display: none;
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É Telegram MainButton */
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: rgba(255, 59, 48, 0.9);
        }

        .toast.success {
            background: rgba(52, 199, 89, 0.9);
        }

        .hint-text {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 4px;
            margin-left: 4px;
        }

        .upload-status {
            text-align: center;
            font-size: 13px;
            margin-top: 8px;
            color: var(--secondary-text);
        }

        .upload-status.success {
            color: var(--success-color);
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 16px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .draft-notice {
            background: rgba(52, 199, 89, 0.1);
            border-left: 3px solid var(--success-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--text-color);
            display: none;
        }

        .info-icon {
            border: 1.5px solid currentColor;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .info-icon:hover {
            opacity: 1;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.06) 25%, rgba(0, 0, 0, 0.12) 50%, rgba(0, 0, 0, 0.06) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 6px;
            display: inline-block;
            height: 14px;
            width: 140px;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <h1 id="mainTitle" onclick="handleTitleClick()">–ù–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ</h1>
    <div id="statsCounter"
        style="text-align: center; color: var(--secondary-text); font-size: 13px; margin-top: -10px; margin-bottom: 20px; opacity: 0.8; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <span id="statsText"><span class="skeleton"></span></span>
        <span class="info-icon" onclick="showStatsInfo()">i</span>
    </div>

    <!-- Draft Notice -->
    <div class="draft-notice" id="draftNotice">
        ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="mainForm" novalidate>
        <div class="section">
            <div class="form-group">
                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                <div class="input-wrapper">
                    <input type="tel" id="department" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 385" required pattern="\d+">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </div>
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è</label>
                <div class="input-wrapper">
                    <input type="tel" id="issue" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" required pattern="\d+">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞</label>
                <div class="input-wrapper">
                    <input type="tel" id="ticket" placeholder="03850006392" required maxlength="11" inputmode="numeric"
                        pattern="[0-9]{11}">
                    <div class="error-message"></div>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 11V7a5 5 0 0 1 10 0v4"></path>
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <div class="hint-text">–†–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä</div>
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <div class="input-wrapper">
                    <input type="date" id="date" required max="">
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="hint-text">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –∏–ª–∏ –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É</div>
            </div>
            <div class="form-group">
                <label>–†–µ–≥–∏–æ–Ω</label>
                <div class="input-wrapper">
                    <select id="region" required>
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                        <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                        <option value="–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                        <option value="–ë–∞—à–∫–∏—Ä–∏—è">–ë–∞—à–∫–∏—Ä–∏—è</option>
                        <option value="–¢—é–º–µ–Ω—å">–¢—é–º–µ–Ω—å</option>
                        <option value="–•–ú–ê–û-–Æ–≥—Ä–∞">–•–ú–ê–û-–Æ–≥—Ä–∞</option>
                        <option value="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</option>
                        <option value="–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫">–ß–µ–ª—è–±–∏–Ω—Å–∫</option>
                        <option value="–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫">–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫</option>
                        <option value="–ö—É—Ä–≥–∞–Ω">–ö—É—Ä–≥–∞–Ω</option>
                        <option value="–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
                    </select>
                    <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 16px; padding: 0 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin:0; font-size: 20px; font-weight: 700;">–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                <span id="itemCountBadge"
                    style="background: var(--accent-color); padding: 4px 10px; border-radius: 12px; font-size: 13px; color: white; font-weight: 600;">1</span>
            </div>
            <div id="itemsList"></div>
            <button type="button" class="btn btn-secondary" onclick="addItem()">
                –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
            </button>
        </div>

        <!-- Encouraging Message -->
        <div id="encouragingMessage"
            style="display: none; background: rgba(52, 199, 89, 0.15); color: #007d3b; padding: 12px; border-radius: 12px; margin-bottom: 24px; font-size: 14px; text-align: center; border: 1px solid rgba(52, 199, 89, 0.3); transition: opacity 0.5s ease; opacity: 0;">
        </div>

        <!-- Mode Toggle (Moved to Bottom) -->
        <label style="margin-left: 4px; margin-bottom: 8px;">–†–µ–∂–∏–º –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
        <div class="segmented-control">
            <input type="radio" name="mode" id="mode-final" value="final" checked>
            <label for="mode-final">–û—Ä–∏–≥–∏–Ω–∞–ª (–í –≥—Ä—É–ø–ø—É)</label>

            <input type="radio" name="mode" id="mode-test" value="test">
            <label for="mode-test">–ß–µ—Ä–Ω–æ–≤–∏–∫ (–¢–µ—Å—Ç)</label>
        </div>

        <div class="sticky-footer"></div>

        <div style="text-align: center; margin-top: 20px; color: var(--secondary-text); font-size: 11px; opacity: 0.5;">
            Version 2.3 (Auto-Key) - 2025-11-24
        </div>
    </form>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            <div id="previewContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closePreview()">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary" style="margin-top:0" onclick="submitForm()"
                    id="finalSubmitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="form-group">
                <label>ImgBB API Key</label>
                <input type="text" id="apiKeyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —Å api.imgbb.com">
                <div class="hint-text">–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</div>
            </div>
            <div class="form-group">
                <label>URL –ë–æ—Ç–∞ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞)</label>
                <input type="text" id="botUrlInput" placeholder="https://... (ngrok/glitch)">
                <div class="hint-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–Ω—É—Ç—Ä–∏ Telegram</div>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="margin-top:10px"
                onclick="document.getElementById('settingsModal').style.display = 'none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        const tg = window.Telegram.WebApp;
        let isSubmitting = false;

        // --- CONFIGURATION ---
        // WARNING: These are default values for local/demo use.
        // For production, consider injecting these via environment variables or a build step.
        const APP_CONFIG = {
            DEFAULT_BOT_URL: window.APP_DEFAULT_BOT_URL || "",
            DEFAULT_IMGBB_KEY: window.APP_DEFAULT_IMGBB_KEY || "364e06e6ef30dffbda1950db29da2a6a"
        };

        // 5. Fetch Stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const data = await response.json();
                    const counter = document.getElementById('statsText');
                    if (counter) {
                        counter.textContent = `üìÖ –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Å–æ–∑–¥–∞–Ω–æ: ${data.count}`;
                    }
                }
            } catch (e) {
                console.warn("Failed to fetch stats", e);
                document.getElementById('statsCounter').style.display = 'none';
            }
        }

        function showStatsInfo() {
            haptic('light');
            tg.showAlert("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–ª—é—á–µ–Ω–∏–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ –≤–∞—à–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.");
        }

        // Initialize
        tg.expand();
        // Assuming restoreDraft() exists elsewhere or will be added.
        // restoreDraft();
        fetchStats();

        // Load API Key (default to the provided one if not in storage)
        let imgbbKey = localStorage.getItem('imgbb_key') || APP_CONFIG.DEFAULT_IMGBB_KEY;

        // Load Bot URL (for standalone mode)
        let botUrl = localStorage.getItem('bot_url') || APP_CONFIG.DEFAULT_BOT_URL;

        // Secret Settings Access
        let titleClicks = 0;
        let titleTimer;

        function populateSettingsInputs() {
            document.getElementById('apiKeyInput').value = imgbbKey;
            document.getElementById('botUrlInput').value = botUrl;
        }

        function handleTitleClick() {
            titleClicks++;
            clearTimeout(titleTimer);
            titleTimer = setTimeout(() => {
                titleClicks = 0;
            }, 1000);

            if (titleClicks >= 5) {
                populateSettingsInputs();
                document.getElementById('settingsModal').style.display = 'block';
                titleClicks = 0;
            }
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const url = document.getElementById('botUrlInput').value.trim();

            if (key) {
                localStorage.setItem('imgbb_key', key);
                imgbbKey = key;
            } else {
                localStorage.removeItem('imgbb_key');
                imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY;
            }

            if (url) {
                // Remove trailing slash
                const cleanUrl = url.replace(/\/$/, "");
                localStorage.setItem('bot_url', cleanUrl);
                botUrl = cleanUrl;
            } else {
                localStorage.removeItem('bot_url');
                botUrl = APP_CONFIG.DEFAULT_BOT_URL;
            }

            document.getElementById('settingsModal').style.display = 'none';
            tg.showAlert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        }

        // Theme handling
        if (tg.themeParams) {
            const r = document.documentElement.style;
        }

        // Set today's date and max date (prevent future dates)
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date');
        dateInput.valueAsDate = new Date();
        dateInput.setAttribute('max', today);


        // --- Constants & State ---
        const MAX_PHOTOS = 30;
        const MAX_PHOTO_SIZE_MB = 5;
        let itemCount = 0;
        let validationClearingAttached = false;

        // --- DOM Elements ---
        const form = document.getElementById('mainForm');
        const itemsContainer = document.getElementById('itemsList');
        const addItemBtn = document.getElementById('addItemBtn');
        const submitBtn = document.getElementById('submitBtn'); // Ensure this ID exists in HTML or use querySelector
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const totalAmountEl = document.getElementById('totalAmount');
        const departmentInput = document.getElementById('department');
        const ticketInput = document.getElementById('ticket');
        const ticketHint = document.getElementById('ticketHint');
        const ticketIcon = document.getElementById('ticketIcon');
        const modeRadios = document.getElementsByName('mode');
        const itemsHeaderCount = document.getElementById('itemCountBadge');
        const encouragingMessage = document.getElementById('encouragingMessage');
        const submitHint = document.getElementById('submitHint');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Restore department
            const savedDept = localStorage.getItem('default_department');
            if (savedDept && departmentInput) {
                departmentInput.value = savedDept;
            }

            // Add initial item
            addItem();
            updateProgress();
            updateSubmitButton();

            // Setup Ticket Validation
            if (ticketInput) {
                ticketInput.addEventListener('input', validateTicket);
            }

            // Setup Mode Change
            Array.from(modeRadios).forEach(radio => {
                radio.addEventListener('change', updateSubmitButton);
            });

            // Department Auto-save
            if (departmentInput) {
                departmentInput.addEventListener('change', (e) => {
                    localStorage.setItem('default_department', e.target.value);
                    checkFirstSectionCompletion();
                });
            }

            // Other inputs for "First Section Completion" check
            const issueInput = document.getElementById('issue');
            const dateInput = document.getElementById('date');
            const regionInput = document.getElementById('region');

            if (issueInput) issueInput.addEventListener('change', checkFirstSectionCompletion);
            if (dateInput) {
                dateInput.addEventListener('change', checkFirstSectionCompletion);
                // Set today's date if empty
                if (!dateInput.value) {
                    dateInput.valueAsDate = new Date();
                }
            }
            if (regionInput) regionInput.addEventListener('change', checkFirstSectionCompletion);

            // Setup automatic validation clearing
            setupInputValidationClearing();

            // Haptic feedback setup
            setupHapticFeedback();

            // Configure native MainButton
            setupMainButton();
        });

        // Automatically clear invalid state when user starts typing/filling fields
        // Automatically clear invalid state using event delegation (handles dynamic inputs too)
        function setupInputValidationClearing() {
            if (validationClearingAttached || !form) {
                console.log('‚ö†Ô∏è Validation clearing skipped:', { attached: validationClearingAttached, hasForm: !!form });
                return;
            }
            validationClearingAttached = true;
            console.log('‚úÖ Validation clearing setup started');

            // Use focusin instead of focus because focus doesn't bubble
            ['input', 'change', 'focusin'].forEach(eventType => {
                form.addEventListener(eventType, (e) => {
                    const input = e.target;
                    // Only process form elements
                    if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(input.tagName)) return;

                    console.log(`üîß Clearing validation for ${input.tagName} (${input.name || input.id})`, {
                        hadInvalid: input.classList.contains('invalid'),
                        value: input.value
                    });

                    // Add .user-editing class to override all invalid styles
                    input.classList.add('user-editing');

                    // Clear invalid class
                    input.classList.remove('invalid');
                    input.setCustomValidity('');

                    // Remove any parent container invalid states
                    const wrapper = input.closest('.input-wrapper, .photo-preview-container');
                    if (wrapper) {
                        wrapper.classList.remove('invalid');
                        wrapper.style.borderColor = '';
                    }
                });
            });

            // Remove .user-editing on blur so validation can show again if needed
            form.addEventListener('blur', (e) => {
                const input = e.target;
                if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(input.tagName)) return;

                // Only remove if field is now valid
                if (input.validity.valid || input.value.trim() !== '') {
                    input.classList.remove('user-editing');
                    console.log(`‚úÖ Removed .user-editing from ${input.name || input.id} (valid: ${input.validity.valid})`);
                }
            }, true);
        }

        // Attach immediately so fields clear errors even if later init fails
        setupInputValidationClearing();

        function setupMainButton() {
            tg.MainButton.setParams({
                text: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å",
                color: "#007AFF",
                text_color: "#FFFFFF",
                is_active: true,
                is_visible: true,
            });
            tg.MainButton.onClick(showPreview);
            tg.MainButton.show();
        }

        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;

            // Haptic feedback
            if (type === 'error') haptic('error');
            else if (type === 'success') haptic('success');
            else haptic('light');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function setupHapticFeedback() {
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('focus', () => haptic('light'));
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', () => haptic('medium'));
            });
        }

        function haptic(type = 'light') {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred(type);
            }
        }

        function checkFirstSectionCompletion() {
            const dept = departmentInput ? departmentInput.value : '';
            const issue = document.getElementById('issue') ? document.getElementById('issue').value : '';
            const ticket = ticketInput ? ticketInput.value : '';
            const date = document.getElementById('date') ? document.getElementById('date').value : '';
            const region = document.getElementById('region') ? document.getElementById('region').value : '';

            if (dept && issue && ticket.length === 11 && date && region) {
                if (encouragingMessage) {
                    encouragingMessage.style.display = 'block';
                    encouragingMessage.textContent = "–û—Ç–ª–∏—á–Ω–æ, –¥–∞–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ç–æ–≤—ã. –¢–µ–ø–µ—Ä—å –æ–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.";
                    setTimeout(() => {
                        encouragingMessage.style.opacity = '1';
                    }, 100);
                }
            }
        }

        function validateTicket() {
            if (!ticketInput) return;
            const val = ticketInput.value.replace(/\D/g, '');
            ticketInput.value = val; // Enforce digits only

            const isValid = val.length === 11;

            ticketInput.classList.toggle('valid', isValid);
            ticketInput.classList.toggle('invalid', !isValid && val.length > 0);

            if (ticketHint) {
                if (isValid) {
                    ticketHint.textContent = "11 —Ü–∏—Ñ—Ä, –≤—Å—ë –æ–∫";
                    ticketHint.style.color = "var(--success-color)";
                } else if (val.length > 0) {
                    ticketHint.textContent = "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 11 —Ü–∏—Ñ—Ä";
                    ticketHint.style.color = "var(--danger-color)";
                } else {
                    ticketHint.textContent = "–†–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä";
                    ticketHint.style.color = "var(--secondary-text)";
                }
            }

            if (ticketIcon) {
                if (isValid) {
                    ticketIcon.style.color = "var(--success-color)";
                    ticketIcon.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                } else {
                    ticketIcon.style.color = val.length > 0 ? "var(--danger-color)" : "var(--secondary-text)";
                    ticketIcon.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2H5z"></path></svg>';
                }
            }
            updateProgress();
            checkFirstSectionCompletion(); // Also check completion when ticket changes
        }

        function updateSubmitButton() {
            // Find the visible submit button (either the main one or the one in preview if we had one)
            // For now, we assume there is a button with onclick="showPreview()" or similar
            const isTest = document.querySelector('input[name="mode"]:checked').value === 'test';
            const buttonText = isTest ? "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫" : "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É";
            try {
                tg.MainButton.setText(buttonText);
            } catch (e) {
                // fallback silently
            }

            if (submitHint) {
                if (itemCount === 0) {
                    submitHint.textContent = "–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç";
                } else {
                    submitHint.textContent = "–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å";
                }
            }
        }

        function addItem() {
            itemCount++;
            if (itemsHeaderCount) itemsHeaderCount.textContent = `(${itemCount})`;

            // Collapse previous items
            const existingItems = document.querySelectorAll('.item-card');
            existingItems.forEach(item => {
                item.classList.add('collapsed');
                const toggleIcon = item.querySelector('.toggle-icon');
                if (toggleIcon) toggleIcon.style.transform = 'rotate(-90deg)';
            });

            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            itemDiv.id = `item-${itemCount}`;

            itemDiv.innerHTML = `
            <div class="item-header" onclick="toggleItem(this)">
                <div class="item-header-info">
                    <div class="item-title">–ü—Ä–µ–¥–º–µ—Ç #${itemCount}</div>
                    <div class="item-summary" id="summary-${itemCount}">–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç</div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="mini-preview" id="mini-preview-${itemCount}"></div>
                    <svg class="toggle-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: transform 0.3s; color: var(--secondary-text);">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div class="item-body">
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                    <div class="input-wrapper">
                        <input type="text" class="desc" name="description_${itemCount}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–ª—å—Ü–æ, –∑–æ–ª–æ—Ç–æ 585" required oninput="updateItemSummary(${itemCount})">
                            <div class="input-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>–û—Ü–µ–Ω–∫–∞ (—Ä—É–±.)</label>
                    <div class="input-wrapper">
                        <input type="tel" class="eval" inputmode="numeric" name="evaluation_${itemCount}" placeholder="0" required oninput="formatPrice(this); updateItemSummary(${itemCount}); calculateTotal();">
                            <div class="input-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--secondary-text); font-weight: 500;">‚ÇΩ</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>–§–æ—Ç–æ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
                    <div class="photo-preview-container" onclick="document.getElementById('photo_${itemCount}').click()">
                        <input type="file" id="photo_${itemCount}" class="file-input" name="photo_${itemCount}" accept="image/*" style="display: none" onchange="handlePhotoSelect(this, ${itemCount})" required>
                            <div class="photo-preview" id="preview_${itemCount}"></div>
                            <div class="upload-label" id="label_${itemCount}">
                                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                                <span class="hint">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</span>
                            </div>
                    </div>
                </div>

                <button type="button" class="btn-remove" onclick="removeItem(${itemCount})">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
                </button>
            </div>
            `;

            itemsContainer.appendChild(itemDiv);

            // Scroll to new item
            setTimeout(() => {
                itemDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);

            updateProgress();
            updateSubmitButton();
        }

        function toggleItem(header) {
            const card = header.parentElement;
            const body = card.querySelector('.item-body');
            const icon = card.querySelector('.toggle-icon');

            card.classList.toggle('collapsed');

            if (card.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(-90deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function updateItemSummary(id) {
            const descInput = document.querySelector(`input[name="description_${id}"]`);
            const priceInput = document.querySelector(`input[name="evaluation_${id}"]`);
            const summaryEl = document.getElementById(`summary-${id}`);

            const desc = descInput.value || "–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç";
            const price = priceInput.value ? `${priceInput.value} ‚ÇΩ` : "";

            summaryEl.textContent = price ? `${desc} ‚Äî ${price}` : desc;
        }

        function formatPrice(input) {
            let val = input.value.replace(/\D/g, '');
            if (val) {
                val = parseInt(val, 10).toLocaleString('ru-RU');
                input.value = val;
            }
        }

        function handlePhotoSelect(input, id) {
            const file = input.files[0];
            if (file) {
                if (file.size > MAX_PHOTO_SIZE_MB * 1024 * 1024) {
                    tg.showAlert(`–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å ${MAX_PHOTO_SIZE_MB} –ú–ë`);
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    // Main preview
                    const preview = document.getElementById(`preview_${id}`);
                    const label = document.getElementById(`label_${id}`);
                    if (preview) {
                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.style.display = 'block';
                    }
                    if (label) {
                        label.style.opacity = '0'; // Hide label but keep input clickable
                    }

                    // Mini preview in header
                    const miniPreview = document.getElementById(`mini-preview-${id}`);
                    if (miniPreview) {
                        miniPreview.style.backgroundImage = `url(${e.target.result})`;
                        miniPreview.style.display = 'block';
                    }
                }
                reader.readAsDataURL(file);
            }
            updateProgress();
        }

        function removeItem(id) {
            const item = document.getElementById(`item-${id}`);
            if (!item) return;

            item.style.transform = 'translateX(100px)';
            item.style.opacity = '0';
            setTimeout(() => {
                item.remove();
                calculateTotal();
                updateProgress();

                // Update total count in header
                const currentItems = document.querySelectorAll('.item-card').length;
                if (itemsHeaderCount) itemsHeaderCount.textContent = `(${currentItems})`;

                if (currentItems === 0) {
                    addItem(); // Always keep at least one
                }
                updateSubmitButton();
            }, 300);
        }

        function calculateTotal() {
            let total = 0;
            const inputs = document.querySelectorAll('input[name^="evaluation_"]');
            inputs.forEach(input => {
                const val = parseInt(input.value.replace(/\s/g, '') || '0');
                total += val;
            });
            if (totalAmountEl) totalAmountEl.textContent = total.toLocaleString('ru-RU');
        }

        function updateProgress() {
            const requiredInputs = form.querySelectorAll('input[required], select[required]');
            let filled = 0;
            requiredInputs.forEach(input => {
                if (input.type === 'file') {
                    if (input.files.length > 0) filled++;
                } else if (input.id === 'ticket') {
                    if (input.value.replace(/\D/g, '').length === 11) filled++;
                } else {
                    if (input.value.trim() !== '') filled++;
                }
            });

            const progress = requiredInputs.length > 0 ? Math.round((filled / requiredInputs.length) * 100) : 0;
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${progress}%`;
        }

        // --- Form Submission & Preview ---
        function showPreview() {
            haptic('medium');

            // Check form validity and mark invalid fields
            if (!form.checkValidity()) {
                const invalidInputs = form.querySelectorAll(':invalid');
                invalidInputs.forEach(input => {
                    input.classList.add('invalid');
                });

                // Show toast instead of blocking alert
                showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');

                // Scroll to first invalid input
                if (invalidInputs.length > 0) {
                    invalidInputs[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => invalidInputs[0].focus(), 300);
                }
                return;
            }

            // Validate Ticket
            const ticketVal = ticketInput.value.replace(/\D/g, '');
            if (ticketVal.length !== 11) {
                showToast('–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä', 'error');
                ticketInput.focus();
                ticketInput.classList.add('invalid');
                return;
            }

            // Check photos
            let allPhotosSelected = true;
            const missingPhotoCards = [];

            document.querySelectorAll('.item-card').forEach(div => {
                const input = div.querySelector('.file-input');
                if (!input.files || !input.files[0]) {
                    allPhotosSelected = false;
                    missingPhotoCards.push(div);
                    const container = div.querySelector('.photo-preview-container');
                    container.style.borderColor = 'var(--danger-color)';
                    container.classList.add('invalid');
                    haptic('error');
                    setTimeout(() => {
                        container.style.borderColor = '';
                        container.classList.remove('invalid');
                    }, 2000);
                }
            });

            if (!allPhotosSelected) {
                showToast(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (${missingPhotoCards.length})`, 'error');
                // Scroll to first missing photo
                if (missingPhotoCards.length > 0) {
                    missingPhotoCards[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            submitForm();
        }

        async function submitForm() {
            if (isSubmitting) return;
            isSubmitting = true;
            tg.MainButton.showProgress(true);
            tg.MainButton.disable();

            const items = [];
            const cards = document.querySelectorAll('.item-card');

            // Upload photos in parallel
            const uploadTasks = Array.from(cards).map(async (div) => {
                const fileInput = div.querySelector('.file-input');
                const file = fileInput.files[0];
                if (!file) {
                    throw new Error("–ù–µ –≤—ã–±—Ä–∞–Ω–æ —Ñ–æ—Ç–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.");
                }

                // Compress
                const compressedBlob = await compressImage(file);

                // Upload to ImgBB
                const formData = new FormData();
                formData.append('image', compressedBlob, 'image.jpg');
                formData.append('key', imgbbKey);

                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result && result.data && result.data.url) {
                    return {
                        description: div.querySelector('.desc').value,
                        evaluation: div.querySelector('.eval').value,
                        photo_url: result.data.url
                    };
                }
                throw new Error("ImgBB Upload Failed");
            });

            try {
                const uploaded = await Promise.all(uploadTasks);
                items.push(...uploaded);
            } catch (e) {
                console.error(e);
                tg.showAlert(e.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                tg.MainButton.hideProgress();
                tg.MainButton.enable();
                isSubmitting = false;
                return;
            }

            const data = {
                department_number: departmentInput.value,
                issue_number: document.getElementById('issue').value,
                ticket_number: ticketInput.value.replace(/\D/g, ''),
                date: document.getElementById('date').value.split('-').reverse().join('.'),
                region: document.getElementById('region').value,
                items: items,
                is_test: document.querySelector('input[name="mode"]:checked').value === 'test'
            };

            tg.sendData(JSON.stringify(data));
            tg.MainButton.hideProgress();
            tg.MainButton.enable();
            isSubmitting = false;
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 1600;  // Increased for better document clarity
                const maxHeight = 1600;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;

                        // Maintain aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // Improved smoothing algorithm
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);

                        // Quality 0.7 for better balance between size and clarity
                        canvas.toBlob(function (blob) {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error("Compression failed"));
                            }
                        }, 'image/jpeg', 0.7);
                    };
                    img.onerror = (e) => reject(new Error("Image load error"));
                };
                reader.onerror = (e) => reject(new Error("File read error"));
            });
        }

        function saveDraft() {
            const draft = {
                department: departmentInput.value,
                issue: document.getElementById('issue').value,
                ticket: ticketInput.value,
                date: document.getElementById('date').value,
                region: document.getElementById('region').value,
                mode: document.querySelector('input[name="mode"]:checked').value
            };
            localStorage.setItem('formDraft', JSON.stringify(draft));
        }

        function restoreDraft() {
            try {
                const draft = JSON.parse(localStorage.getItem('formDraft'));
                if (draft) {
                    if (draft.department) departmentInput.value = draft.department;
                    if (draft.issue) document.getElementById('issue').value = draft.issue;
                    if (draft.ticket) ticketInput.value = draft.ticket;
                    if (draft.date) document.getElementById('date').value = draft.date;
                    if (draft.region) document.getElementById('region').value = draft.region;
                    if (draft.mode) {
                        const modeInput = document.querySelector(`input[name="mode"][value="${draft.mode}"]`);
                        if (modeInput) modeInput.checked = true;
                    }
                    updateSubmitButton();
                    checkFirstSectionCompletion();
                }
            } catch (e) {
                console.error("Error restoring draft:", e);
            }
        }

        function clearDraft() {
            localStorage.removeItem('formDraft');
        }

        // Create debounced autosave (saves after 1 second of inactivity)
        const autoSave = debounce(() => {
            saveDraft();
            console.log('‚úÖ Draft saved');
        }, 1000);

        // Setup autosave listeners on form inputs
        form.addEventListener('input', autoSave);
        form.addEventListener('change', autoSave);

        // Restore draft on page load
        restoreDraft();
    </script>
</body>

</html>