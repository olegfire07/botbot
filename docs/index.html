<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007AFF;
            --primary-hover: #0062cc;
            --text-color: #1d1d1f;
            --secondary-text: #86868b;
            --card-bg: rgba(255, 255, 255, 0.75);
            --input-bg: rgba(255, 255, 255, 0.5);
            --border-color: rgba(0, 0, 0, 0.05);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 12px 24px rgba(0, 0, 0, 0.06);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --radius-lg: 20px;
            --radius-md: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            background-color: #f5f5f7;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes gradient-animation {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Light Theme Override for Mesh */
        @media (prefers-color-scheme: light) {
            body {
                background-color: #ffffff;
                background-image:
                    radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 0%, hsla(189, 100%, 56%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 1) 0px, transparent 50%),
                    radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 1) 0px, transparent 50%),
                    radial-gradient(at 0% 0%, hsla(343, 100%, 76%, 1) 0px, transparent 50%);
            }
        }

        h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #1d1d1f 0%, #434344 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeInUp 0.6s ease-out;
        }

        .section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: var(--glass-border);
            animation: fadeInUp 0.6s ease-out 0.1s backwards;
        }

        .form-group {
            margin-bottom: 20px;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        /* Staggered Animation Delays */
        .form-group:nth-child(1) {
            animation-delay: 0.15s;
        }

        .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .form-group:nth-child(3) {
            animation-delay: 0.25s;
        }

        .form-group:nth-child(4) {
            animation-delay: 0.3s;
        }

        .form-group:nth-child(5) {
            animation-delay: 0.35s;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input,
        select {
            width: 100%;
            padding: 16px;
            border: 1px solid transparent;
            background: var(--input-bg);
            border-radius: var(--radius-md);
            font-size: 17px;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-color);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        input:focus,
        select:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
            transform: translateY(-1px);
        }

        .item-card {
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: fadeInUp 0.6s ease-out backwards;
        }

        .item-card:hover {
            transform: scale(1.01);
            background: rgba(255, 255, 255, 0.8);
            box-shadow: var(--shadow-sm);
        }

        .btn {
            padding: 18px;
            border-radius: var(--radius-lg);
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.01em;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.96);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Validation Error */
        .invalid {
            border-color: var(--danger-color) !important;
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
            background: rgba(255, 59, 48, 0.05) !important;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            color: var(--primary-color);
            border: 1px solid rgba(0, 122, 255, 0.1);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <h1 id="mainTitle" onclick="handleTitleClick()">–ù–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ</h1>
    <div id="statsCounter"
        style="text-align: center; color: var(--secondary-text); font-size: 13px; margin-top: -10px; margin-bottom: 20px; opacity: 0.8;">
        üìÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
    </div>

    <!-- Draft Notice -->
    <div class="draft-notice" id="draftNotice">
        ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="mainForm">
        <div class="section">
            <div class="form-group">
                <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                <input type="tel" id="department" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 385" required pattern="\d+">
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏—è</label>
                <input type="tel" id="issue" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12" required pattern="\d+">
            </div>
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞</label>
                <input type="tel" id="ticket" placeholder="03850006392" required maxlength="11">
                <div class="hint-text">–†–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä</div>
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label>–†–µ–≥–∏–æ–Ω</label>
                <select id="region" required>
                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                    <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                    <option value="–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                    <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                    <option value="–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥">–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                    <option value="–ë–∞—à–∫–∏—Ä–∏—è">–ë–∞—à–∫–∏—Ä–∏—è</option>
                    <option value="–¢—é–º–µ–Ω—å">–¢—é–º–µ–Ω—å</option>
                    <option value="–•–ú–ê–û-–Æ–≥—Ä–∞">–•–ú–ê–û-–Æ–≥—Ä–∞</option>
                    <option value="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</option>
                    <option value="–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                    <option value="–ß–µ–ª—è–±–∏–Ω—Å–∫">–ß–µ–ª—è–±–∏–Ω—Å–∫</option>
                    <option value="–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫">–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫</option>
                    <option value="–ö—É—Ä–≥–∞–Ω">–ö—É—Ä–≥–∞–Ω</option>
                    <option value="–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 16px; padding: 0 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin:0; font-size: 20px; font-weight: 700;">–ü—Ä–µ–¥–º–µ—Ç—ã</h3>
                <span id="itemCountBadge"
                    style="background: var(--accent-color); padding: 4px 10px; border-radius: 12px; font-size: 13px; color: white; font-weight: 600;">1</span>
            </div>
            <div id="itemsList"></div>
            <button type="button" class="btn btn-secondary" onclick="addItem()">
                –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
            </button>
        </div>

        <!-- Mode Toggle (Moved to Bottom) -->
        <div class="segmented-control">
            <input type="radio" name="mode" id="mode-final" value="final" checked>
            <label for="mode-final">–û—Ä–∏–≥–∏–Ω–∞–ª (–í –≥—Ä—É–ø–ø—É)</label>

            <input type="radio" name="mode" id="mode-test" value="test">
            <label for="mode-test">–ß–µ—Ä–Ω–æ–≤–∏–∫ (–¢–µ—Å—Ç)</label>
        </div>

        <button type="button" class="btn btn-primary" onclick="showPreview()">
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
    </form>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            <div id="previewContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closePreview()">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary" style="margin-top:0" onclick="submitForm()"
                    id="finalSubmitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="form-group">
                <label>ImgBB API Key</label>
                <input type="text" id="apiKeyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —Å api.imgbb.com">
                <div class="hint-text">–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</div>
            </div>
            <div class="form-group">
                <label>URL –ë–æ—Ç–∞ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞)</label>
                <input type="text" id="botUrlInput" placeholder="https://... (ngrok/glitch)">
                <div class="hint-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–Ω—É—Ç—Ä–∏ Telegram</div>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" style="margin-top:10px"
                onclick="document.getElementById('settingsModal').style.display = 'none'">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        // --- CONFIGURATION ---
        // WARNING: These are default values for local/demo use.
        // For production, consider injecting these via environment variables or a build step.
        const APP_CONFIG = {
            DEFAULT_BOT_URL: window.APP_DEFAULT_BOT_URL || "https://55181ef25a05.ngrok-free.app",
            DEFAULT_IMGBB_KEY: window.APP_DEFAULT_IMGBB_KEY || "c8574310f13ff081e6ed7e3c9f963f9f"
        };

        // 5. Fetch Stats
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const data = await response.json();
                    const counter = document.getElementById('statsCounter');
                    counter.textContent = `üìÖ –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ —Å–æ–∑–¥–∞–Ω–æ: ${data.count}`;
                }
            } catch (e) {
                console.warn("Failed to fetch stats", e);
                document.getElementById('statsCounter').style.display = 'none';
            }
        }

        // Initialize
        tg.expand();
        // Assuming restoreDraft() exists elsewhere or will be added.
        // restoreDraft();
        fetchStats();

        // Load API Key (default to the provided one if not in storage)
        let imgbbKey = localStorage.getItem('imgbb_key') || APP_CONFIG.DEFAULT_IMGBB_KEY;

        // Load Bot URL (for standalone mode)
        let botUrl = localStorage.getItem('bot_url') || APP_CONFIG.DEFAULT_BOT_URL;

        // Secret Settings Access
        let titleClicks = 0;
        let titleTimer;

        function populateSettingsInputs() {
            document.getElementById('apiKeyInput').value = imgbbKey;
            document.getElementById('botUrlInput').value = botUrl;
        }

        function handleTitleClick() {
            titleClicks++;
            clearTimeout(titleTimer);
            titleTimer = setTimeout(() => {
                titleClicks = 0;
            }, 1000);

            if (titleClicks >= 5) {
                populateSettingsInputs();
                document.getElementById('settingsModal').style.display = 'block';
                titleClicks = 0;
            }
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const url = document.getElementById('botUrlInput').value.trim();

            if (key) {
                localStorage.setItem('imgbb_key', key);
                imgbbKey = key;
            } else {
                localStorage.removeItem('imgbb_key');
                imgbbKey = APP_CONFIG.DEFAULT_IMGBB_KEY;
            }

            if (url) {
                // Remove trailing slash
                const cleanUrl = url.replace(/\/$/, "");
                localStorage.setItem('bot_url', cleanUrl);
                botUrl = cleanUrl;
            } else {
                localStorage.removeItem('bot_url');
                botUrl = APP_CONFIG.DEFAULT_BOT_URL;
            }

            document.getElementById('settingsModal').style.display = 'none';
            tg.showAlert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        }

        // Theme handling
        if (tg.themeParams) {
            const r = document.documentElement.style;
        }

        document.getElementById('date').valueAsDate = new Date();

        let itemCount = 0;

        function addItem() {
            itemCount++;
            updateBadge();

            const div = document.createElement('div');
            div.className = 'item-card';
            div.id = `item-${itemCount}`;
            div.innerHTML = `
                <div class="item-header">
                    <span class="item-title">–ü—Ä–µ–¥–º–µ—Ç #${itemCount}</span>
                    <div style="display: flex; gap: 8px;">
                        ${itemCount > 1 ? `<button type="button" class="btn-remove" onclick="removeItem(this)">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                    </div>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" class="desc" placeholder="–ß—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–µ–¥–º–µ—Ç?" required>
                </div>
                <div class="form-group">
                    <label>–û—Ü–µ–Ω–∫–∞ (—Ä—É–±)</label>
                    <input type="tel" class="eval" placeholder="–°—É–º–º–∞" required pattern="\\d+">
                </div>
                <div class="photo-preview-container" 
                     ondragover="handleDragOver(event)" 
                     ondragleave="handleDragLeave(event)" 
                     ondrop="handleDrop(event, this)">
                    <div class="photo-preview"></div>
                    <label class="upload-label">
                        <input type="file" class="file-input" accept="image/*" onchange="handleFileSelect(this)">
                        <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                        <span class="hint">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ</span>
                    </label>
                </div>
                <div class="upload-status">–§–æ—Ç–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
            `;
            document.getElementById('itemsList').appendChild(div);
        }

        function removeItem(btn) {
            btn.closest('.item-card').remove();
            updateBadge();
        }

        function updateBadge() {
            const count = document.getElementById('itemsList').children.length;
            document.getElementById('itemCountBadge').textContent = count;
        }

        // --- UX Features ---

        // 1. Drag & Drop
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.style.borderColor = 'var(--primary-color)';
            e.currentTarget.style.background = 'rgba(0, 122, 255, 0.05)';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.style.borderColor = 'rgba(0, 0, 0, 0.1)';
            e.currentTarget.style.background = 'rgba(0, 0, 0, 0.03)';
        }

        function handleDrop(e, container) {
            e.preventDefault();
            e.stopPropagation();

            container.style.borderColor = 'rgba(0, 0, 0, 0.1)';
            container.style.background = 'rgba(0, 0, 0, 0.03)';

            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files[0]) {
                const fileInput = container.querySelector('.file-input');
                fileInput.files = files;
                handleFileSelect(fileInput);
            }
        }

        // 3. Input Mask for Ticket (Digits only, max 11)
        document.getElementById('ticket').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 11);
        });

        // 4. Smart Memory (Department & Region)
        const deptInput = document.getElementById('department');
        const regionInput = document.getElementById('region');

        // Load defaults if not draft
        if (!localStorage.getItem('formDraft')) {
            const savedDept = localStorage.getItem('default_department');
            const savedRegion = localStorage.getItem('default_region');
            if (savedDept) deptInput.value = savedDept;
            if (savedRegion) regionInput.value = savedRegion;
        }

        // Save on change
        deptInput.addEventListener('change', (e) => {
            localStorage.setItem('default_department', e.target.value);
        });

        regionInput.addEventListener('change', (e) => {
            localStorage.setItem('default_region', e.target.value);
        });

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const container = input.closest('.item-card');
            const preview = container.querySelector('.photo-preview');
            const btnText = container.querySelector('.btn-text');
            const status = container.querySelector('.upload-status');

            // Preview
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.style.display = 'block';
                btnText.textContent = "–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ";
                status.textContent = "–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ";
                status.className = "upload-status success";
            };
            reader.readAsDataURL(file);
        }

        function showPreview() {
            const form = document.getElementById('mainForm');
            let isValid = true;

            // 1. Check required fields
            form.querySelectorAll('input[required], select[required]').forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('invalid');
                    // Remove error on input
                    input.addEventListener('input', () => input.classList.remove('invalid'), { once: true });
                }
            });

            if (!isValid) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!");
                return;
            }

            const ticket = document.getElementById('ticket').value;
            if (ticket.length !== 11) {
                const ticketInput = document.getElementById('ticket');
                ticketInput.classList.add('invalid');
                ticketInput.addEventListener('input', () => ticketInput.classList.remove('invalid'), { once: true });
                tg.showAlert("–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 11 —Ü–∏—Ñ—Ä!");
                return;
            }

            // Check photos
            let allPhotosSelected = true;
            document.querySelectorAll('.item-card').forEach(div => {
                const input = div.querySelector('.file-input');
                if (!input.files || !input.files[0]) {
                    allPhotosSelected = false;
                    const container = div.querySelector('.photo-preview-container');
                    container.style.borderColor = 'var(--danger-color)';
                    container.style.animation = 'shake 0.4s cubic-bezier(.36, .07, .19, .97) both';

                    // Remove error on click/drop
                    input.addEventListener('change', () => {
                        container.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        container.style.animation = 'none';
                    }, { once: true });
                }
            });

            if (!allPhotosSelected) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤!");
                return;
            }

            const isTest = document.getElementById('mode-test').checked;
            const modeText = isTest ? "–ß–µ—Ä–Ω–æ–≤–∏–∫ (–¢–µ—Å—Ç)" : "–û—Ä–∏–≥–∏–Ω–∞–ª (–í –≥—Ä—É–ø–ø—É)";

            // Build preview
            const content = document.getElementById('previewContent');
            content.innerHTML = `
                <div class="preview-row"><span class="preview-label">–†–µ–∂–∏–º:</span> <div class="preview-value" style="color: ${isTest ? 'orange' : 'green'}">${modeText}</div></div>
                <div class="preview-row"><span class="preview-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span> <div class="preview-value">${document.getElementById('department').value}</div></div>
                <div class="preview-row"><span class="preview-label">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:</span> <div class="preview-value">${document.getElementById('issue').value}</div></div>
                <div class="preview-row"><span class="preview-label">–ë–∏–ª–µ—Ç:</span> <div class="preview-value">${ticket}</div></div>
                <div class="preview-row"><span class="preview-label">–î–∞—Ç–∞:</span> <div class="preview-value">${document.getElementById('date').value}</div></div>
                <div class="preview-row"><span class="preview-label">–†–µ–≥–∏–æ–Ω:</span> <div class="preview-value">${document.getElementById('region').value}</div></div>
                <div class="preview-row"><span class="preview-label">–ü—Ä–µ–¥–º–µ—Ç–æ–≤:</span> <div class="preview-value">${document.querySelectorAll('.item-card').length}</div></div>
            `;

            document.getElementById('previewModal').style.display = 'block';
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Image Compression Helper
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 1280;
                const maxHeight = 1280;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(function (blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.8); // 80% quality
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function submitForm() {
            const btn = document.getElementById('finalSubmitBtn');
            btn.disabled = true;
            btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ ImgBB...";

            const items = [];
            const cards = document.querySelectorAll('.item-card');

            // Upload photos one by one to ImgBB
            for (let i = 0; i < cards.length; i++) {
                const div = cards[i];
                const fileInput = div.querySelector('.file-input');
                const file = fileInput.files[0];

                // Skip if no file selected
                if (!file) {
                    console.warn(`Skipping item ${i + 1} - no photo selected`);
                    continue;
                }

                // Update progress
                updateProgress(i, cards.length);
                btn.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ ${i + 1}/${cards.length}...`;

                try {
                    // Compress first
                    const compressedBlob = await compressImage(file);

                    const formData = new FormData();
                    formData.append('image', compressedBlob, 'image.jpg');
                    formData.append('key', imgbbKey);

                    const response = await fetch('https://api.imgbb.com/1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result && result.data && result.data.url) {
                        items.push({
                            description: div.querySelector('.desc').value,
                            evaluation: div.querySelector('.eval').value,
                            photo_url: result.data.url
                        });
                    } else {
                        throw new Error("ImgBB Error: " + (result.error ? result.error.message : "Unknown error"));
                    }

                } catch (e) {
                    console.error("Upload failed", e);
                    tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message || e}`);
                    btn.disabled = false;
                    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                    return;
                }
            }

            btn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

            try {
                const isTest = document.getElementById('mode-test').checked;

                const data = {
                    department_number: document.getElementById('department').value,
                    issue_number: document.getElementById('issue').value,
                    ticket_number: document.getElementById('ticket').value,
                    date: document.getElementById('date').value.split('-').reverse().join('.'),
                    region: document.getElementById('region').value,
                    items: items,
                    is_test: isTest
                };

                // Check if running in Telegram
                // We check if initDataUnsafe is present and has user info
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    tg.sendData(JSON.stringify(data));
                } else {
                    // Standalone Mode
                    if (!botUrl) {
                        populateSettingsInputs();
                        document.getElementById('settingsModal').style.display = 'block';
                        tg.showAlert("–î–ª—è —Ä–∞–±–æ—Ç—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å URL –±–æ—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ngrok –∞–¥—Ä–µ—Å).");
                        btn.disabled = false;
                        btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                        return;
                    }

                    btn.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...";

                    // Add timeout to fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                    const response = await fetch(botUrl + '/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        btn.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...";
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.error || `Server Error: ${response.status}`);
                    }

                    btn.textContent = "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...";

                    // Download File
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Conclusion_${data.ticket_number}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    clearDraft(); // Add clear draft call after successful submission
                    alert("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∏ —Å–∫–∞—á–∞–Ω!");
                    closePreview();
                    btn.disabled = false;
                    btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
                }
            } catch (e) {
                console.error("Submission Error", e);
                if (e.name === 'AbortError') {
                    alert("–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30—Å). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ URL –±–æ—Ç–∞.");
                } else {
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${e.message}`);
                }
                btn.disabled = false;
                btn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            }
        }

        // Initial item
        addItem();

        // ============================================
        // AUTO-SAVE DRAFT & RESTORE
        // ============================================
        function saveDraft() {
            const draft = {
                department: document.getElementById('department').value,
                issue: document.getElementById('issue').value,
                ticket: document.getElementById('ticket').value,
                date: document.getElementById('date').value,
                region: document.getElementById('region').value,
                timestamp: Date.now()
            };
            localStorage.setItem('formDraft', JSON.stringify(draft));
        }

        function restoreDraft() {
            const draftStr = localStorage.getItem('formDraft');
            if (!draftStr) return;

            const draft = JSON.parse(draftStr);
            // Only restore if draft is less than 24 hours old
            const hoursSinceLastSave = (Date.now() - draft.timestamp) / (1000 * 60 * 60);
            if (hoursSinceLastSave > 24) {
                localStorage.removeItem('formDraft');
                return;
            }

            // Restore values
            if (draft.department) document.getElementById('department').value = draft.department;
            if (draft.issue) document.getElementById('issue').value = draft.issue;
            if (draft.ticket) document.getElementById('ticket').value = draft.ticket;
            if (draft.date) document.getElementById('date').value = draft.date;
            if (draft.region) document.getElementById('region').value = draft.region;

            // Show notice
            const notice = document.getElementById('draftNotice');
            notice.style.display = 'block';
            setTimeout(() => {
                notice.style.opacity = '0';
                notice.style.transition = 'opacity 1s';
                setTimeout(() => notice.style.display = 'none', 1000);
            }, 3000);
        }

        function clearDraft() {
            localStorage.removeItem('formDraft');
        }

        // Update progress bar
        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const percent = (current / total) * 100;

            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';

            if (current === total) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }

        // Auto-save every 2 seconds
        setInterval(saveDraft, 2000);

        // Restore draft on page load
        restoreDraft();

        // Add item (with numbering)
        let itemCounter = 1;
    </script>
</body>

</html>