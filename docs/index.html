<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conclusion Form</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        input, select, textarea { width: 100%; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h2>Create Conclusion</h2>
    <form id="mainForm">
        <input type="text" id="department" placeholder="Department Number" required pattern="\d+">
        <input type="text" id="issue" placeholder="Issue Number" required pattern="\d+">
        <input type="text" id="ticket" placeholder="Ticket Number" required pattern="\d{11}">
        <input type="date" id="date" required>
        <select id="region" required>
            <option value="" disabled selected>Select Region</option>
            <option value="Санкт-Петербург">Санкт-Петербург</option>
            <option value="Свердловская область">Свердловская область</option>
            <option value="Челябинская область">Челябинская область</option>
            <option value="Екатеринбург">Екатеринбург</option>
            <option value="Башкирия">Башкирия</option>
            <option value="Тюмень">Тюмень</option>
            <option value="ХМАО-Югра">ХМАО-Югра</option>
            <option value="Нижний Новгород">Нижний Новгород</option>
            <option value="Ростовская область">Ростовская область</option>
            <option value="Челябинск">Челябинск</option>
            <option value="Магнитогорск">Магнитогорск</option>
            <option value="Курган">Курган</option>
            <option value="Краснодарский край">Краснодарский край</option>
        </select>
        
        <div id="items"></div>
        <button type="button" onclick="addItem()" style="background-color: #555; margin-bottom: 15px;">+ Add Item</button>
        
        <button type="submit">Submit</button>
    </form>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        function addItem() {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <h3>Item</h3>
                <input type="text" class="desc" placeholder="Description" required>
                <input type="number" class="eval" placeholder="Evaluation (RUB)" required>
                <!-- Photo upload is tricky in Web App directly sending to bot, 
                     usually we send data back and ask for photos or use external upload.
                     For simplicity in this version, we will ask for photos in chat after data submission 
                     OR we can try to use input type file but passing it to bot is hard without server.
                     Let's stick to data entry here and photo upload in chat for now to keep it simple without backend server.
                     WAIT, the user wants "fool-proof". 
                     Let's try to just send text data and then prompt for photos in chat.
                -->
                <p style="font-size: 12px; color: #777;">* Photos will be requested in chat after submission.</p>
            `;
            document.getElementById('items').appendChild(div);
        }
        
        // Add one item by default
        addItem();

        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const items = [];
            document.querySelectorAll('.item').forEach(div => {
                items.push({
                    description: div.querySelector('.desc').value,
                    evaluation: div.querySelector('.eval').value
                });
            });

            const data = {
                department_number: document.getElementById('department').value,
                issue_number: document.getElementById('issue').value,
                ticket_number: document.getElementById('ticket').value,
                date: document.getElementById('date').value.split('-').reverse().join('.'), // YYYY-MM-DD -> DD.MM.YYYY
                region: document.getElementById('region').value,
                items: items
            };

            tg.sendData(JSON.stringify(data));
        });
    </script>
</body>
</html>
